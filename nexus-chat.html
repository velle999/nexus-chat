<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS P2P</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg0:#06060e;--bg1:#0a0a14;--bg2:#0e0e1c;--bg3:#14142a;--bg4:#1a1a36;--brd:rgba(255,255,255,.06);--brdL:rgba(255,255,255,.1);--txt:#d0d0e8;--mut:#666688;--fnt:#444466;--acc:#00ffd5;--accD:rgba(0,255,213,.15);--red:#ff4466;--grn:#44ff88;--pink:#ff6bfa;--warn:#ffaa00;--ff:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace}
html,body{height:100%;overflow:hidden;background:var(--bg1);color:var(--txt);font-family:var(--ff)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
::selection{background:rgba(0,255,213,.2);color:#fff}
input,textarea{font-family:var(--ff)}
input::placeholder{color:var(--fnt)}
input:focus,button:focus-visible{outline:2px solid rgba(0,255,213,.3);outline-offset:2px}
button:focus:not(:focus-visible){outline:none}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-4px);opacity:1}}
.msg-enter{animation:fadeIn .2s ease}
.dot{animation:typing 1s infinite;display:inline-block;font-size:8px}

/* Layout */
#app{display:flex;height:100vh;width:100vw;overflow:hidden}
.sidebar{width:260px;min-width:260px;background:var(--bg2);display:flex;flex-direction:column;border-right:1px solid var(--brd);flex-shrink:0}
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.members-panel{width:220px;min-width:220px;background:var(--bg2);border-left:1px solid var(--brd);overflow-y:auto;flex-shrink:0}

/* Sidebar */
.sb-header{padding:16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px}
.sb-header h2{font-size:16px;font-weight:800;color:#fff;font-family:var(--mono);letter-spacing:.5px}
.room-section{padding:12px 16px}
.room-code{display:flex;align-items:center;gap:8px;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.room-code:hover{border-color:var(--acc)}
.room-code .code{font-family:var(--mono);font-size:14px;color:var(--acc);font-weight:700;flex:1;letter-spacing:1px}
.room-code .label{font-size:10px;color:var(--mut);font-weight:600;letter-spacing:1px;text-transform:uppercase}
.copy-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--brdL);border-radius:8px;padding:8px 16px;color:var(--acc);font-size:13px;font-weight:600;z-index:999;animation:modalIn .15s ease;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.peer-list{flex:1;overflow-y:auto;padding:0 8px}
.peer-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;transition:background .1s}
.peer-item:hover{background:rgba(255,255,255,.04)}
.peer-av{width:34px;height:34px;min-width:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:14px;position:relative;flex-shrink:0}
.peer-av .status{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2.5px solid var(--bg2)}
.peer-name{font-weight:600;font-size:13px}
.peer-status{font-size:10px;color:var(--mut)}
.user-panel{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg0);border-top:1px solid var(--brd)}
.user-panel .name{font-family:var(--mono);font-size:12px;font-weight:700}
.user-panel .st{font-size:10px;color:var(--fnt)}

/* Chat */
.chat-header{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--brd);min-height:50px;gap:8px}
.chat-header h3{font-size:15px;font-weight:700;color:#fff}
.chat-header .topic{color:var(--fnt);font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:12px}
.msg-list{flex:1;overflow-y:auto;padding:0 0 8px}
.msg-welcome{padding:32px 16px 16px}
.msg-welcome h2{font-size:22px;font-weight:800;color:#fff;margin:0 0 4px}
.msg-welcome p{color:var(--mut);font-size:13px}
.date-divider{display:flex;align-items:center;gap:8px;padding:16px 16px 4px}
.date-divider span{font-size:11px;font-weight:600;color:var(--mut);font-family:var(--mono);white-space:nowrap}
.date-divider .line{flex:1;height:1px;background:var(--brd)}
.message{display:flex;gap:12px;padding:6px 16px;transition:background .1s;position:relative}
.message:hover{background:rgba(255,255,255,.03)}
.message.compact{padding:1px 16px 1px 62px}
.msg-author{font-weight:700;font-size:14px;font-family:var(--mono);cursor:default}
.msg-time{color:var(--fnt);font-size:11px;font-family:var(--mono)}
.msg-body{color:var(--txt);font-size:14px;line-height:1.55;word-break:break-word}
.msg-edited{font-size:10px;color:var(--fnt)}
.reactions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.reaction{background:rgba(255,255,255,.05);border:1px solid var(--brd);border-radius:10px;padding:2px 8px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:3px;transition:all .15s}
.reaction.mine{background:var(--accD);border-color:rgba(0,255,213,.3)}
.reaction span{font-family:var(--mono);font-size:11px}
.msg-actions{position:absolute;top:-4px;right:12px;display:flex;gap:1px;background:var(--bg3);border-radius:6px;border:1px solid var(--brdL);padding:2px;z-index:5;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.act-btn{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:14px;background:none;border:none;color:var(--mut);transition:background .1s}
.act-btn:hover{background:rgba(255,255,255,.08)}
.emoji-picker{position:absolute;top:32px;right:0;display:flex;gap:2px;background:var(--bg3);border-radius:8px;border:1px solid var(--brdL);padding:6px;z-index:10;box-shadow:0 8px 24px rgba(0,0,0,.4);flex-wrap:wrap;width:200px}
.emoji-opt{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:20px;background:none;border:none;transition:background .1s}
.emoji-opt:hover{background:rgba(255,255,255,.08)}

/* Input */
.input-area{padding:0 16px 14px;flex-shrink:0}
.input-row{display:flex;align-items:center;background:var(--bg3);border-radius:8px;border:1px solid var(--brd);padding:0 6px}
.input-row input{flex:1;background:transparent;border:none;color:var(--txt);font-size:14px;padding:12px 8px;min-width:0}
.input-row button{padding:8px;cursor:pointer;border-radius:4px;background:none;border:none;color:var(--fnt);font-size:14px;transition:color .15s}
.input-row button:hover{color:var(--acc)}
.input-row button.active{color:var(--acc)}
.typing-bar{padding:4px 12px 2px;font-size:11px;color:var(--mut);min-height:18px}

/* Connection screen */
.connect-screen{display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;background:var(--bg1)}
.connect-card{background:var(--bg2);border:1px solid var(--brdL);border-radius:16px;padding:40px;width:440px;max-width:90vw;text-align:center;animation:modalIn .3s ease;box-shadow:0 16px 48px rgba(0,0,0,.5)}
.connect-card h1{font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.connect-card .sub{color:var(--mut);font-size:14px;margin-bottom:32px}
.connect-card label{display:block;text-align:left;font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--mut);margin-bottom:8px}
.connect-card input{width:100%;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:12px 14px;color:var(--txt);font-size:14px;margin-bottom:16px;font-family:var(--ff)}
.connect-card .mono-input{font-family:var(--mono);letter-spacing:2px;text-align:center;font-size:18px}
.btn-primary{width:100%;padding:12px 20px;border-radius:8px;background:var(--acc);color:var(--bg0);font-weight:700;font-size:15px;cursor:pointer;border:none;font-family:var(--ff);transition:opacity .15s;margin-bottom:10px}
.btn-primary:hover{opacity:.9}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{width:100%;padding:12px 20px;border-radius:8px;background:transparent;color:var(--txt);font-weight:600;font-size:14px;cursor:pointer;border:1px solid var(--brd);font-family:var(--ff);transition:background .15s}
.btn-secondary:hover{background:rgba(255,255,255,.04)}
.divider-text{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--fnt);font-size:12px;font-weight:600}
.divider-text .line{flex:1;height:1px;background:var(--brd)}
.conn-status{display:flex;align-items:center;gap:6px;justify-content:center;margin-top:16px;font-size:12px;color:var(--mut)}
.conn-status .dot{width:8px;height:8px;border-radius:50%;animation:pulse 1.5s infinite}
.color-pick{display:flex;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:14px;cursor:pointer;border:3px solid transparent;transition:border-color .15s,opacity .15s;opacity:.6}
.color-swatch.active{border-color:#fff;opacity:1}

/* Members panel */
.mem-header{padding:14px 14px 6px;font-weight:700;font-size:11px;letter-spacing:1.5px;color:var(--mut)}
.mem-group-label{padding:12px 14px 4px;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase}

/* Responsive */
@media(max-width:900px){.members-panel{display:none}}
@media(max-width:600px){.sidebar{position:fixed;left:0;top:0;bottom:0;z-index:50;transform:translateX(-100%);transition:transform .2s}.sidebar.open{transform:translateX(0)}.mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40}}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEXUS P2P â€” Serverless WebRTC Chat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const COLORS = ["#00ffd5","#ff6bfa","#ffd000","#ff4466","#44ffaa","#6b9fff","#ff9944","#aa66ff"];
const EMOJIS = ["ğŸ‘","ğŸ”¥","ğŸ’œ","ğŸ˜‚","ğŸš€","ğŸ‘€","â¤ï¸","ğŸ‰"];
const ROOM_CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";

function genRoomCode() {
  let code = "";
  for (let i = 0; i < 6; i++) code += ROOM_CHARS[Math.floor(Math.random() * ROOM_CHARS.length)];
  return code;
}

function genPeerId(room, extra) {
  return "nexus-" + room + "-" + extra;
}

function formatTime(d) {
  return new Date(d).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function formatDate(d) {
  const date = new Date(d);
  const now = new Date();
  const diff = now - date;
  if (diff < 86400000 && date.getDate() === now.getDate()) return "Today";
  if (diff < 172800000) return "Yesterday";
  return date.toLocaleDateString([], { month: "short", day: "numeric" });
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const state = {
  screen: "connect", // connect | chat
  me: { id: "", name: "", color: COLORS[0], avatar: "" },
  roomCode: "",
  peer: null,
  connections: new Map(), // peerId -> { conn, user }
  peers: [], // [{ id, name, color, avatar, status }]
  messages: [],
  typing: new Set(),
  connected: false,
  showMembers: true,
  mobileSidebar: false,
  copyToast: false,
};

let renderQueued = false;
function queueRender() {
  if (!renderQueued) { renderQueued = true; requestAnimationFrame(() => { renderQueued = false; render(); }); }
}

// â”€â”€ P2P Network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function broadcast(data) {
  const json = JSON.stringify(data);
  state.connections.forEach(({ conn }) => {
    if (conn.open) conn.send(json);
  });
}

function handleData(peerId, raw) {
  let data;
  try { data = JSON.parse(raw); } catch { return; }

  switch (data.type) {
    case "hello": {
      const user = data.user;
      state.connections.get(peerId).user = user;
      refreshPeerList();
      // Send back our info
      const conn = state.connections.get(peerId)?.conn;
      if (conn?.open) conn.send(JSON.stringify({ type: "hello", user: state.me }));
      // Send message history to new peer
      if (state.messages.length > 0) {
        conn.send(JSON.stringify({ type: "sync", messages: state.messages }));
      }
      // Announce
      addSystemMessage(`${user.name} joined the room`);
      break;
    }
    case "sync": {
      // Merge messages we don't have
      const existing = new Set(state.messages.map(m => m.id));
      const newMsgs = data.messages.filter(m => !existing.has(m.id));
      if (newMsgs.length) {
        state.messages = [...state.messages, ...newMsgs].sort((a, b) => a.ts - b.ts);
        queueRender();
      }
      break;
    }
    case "message": {
      if (!state.messages.find(m => m.id === data.msg.id)) {
        state.messages.push(data.msg);
        state.typing.delete(data.msg.userId);
        queueRender();
        scrollToBottom();
      }
      break;
    }
    case "typing": {
      state.typing.add(data.userId);
      queueRender();
      setTimeout(() => { state.typing.delete(data.userId); queueRender(); }, 3000);
      break;
    }
    case "reaction": {
      const msg = state.messages.find(m => m.id === data.msgId);
      if (msg) {
        if (!msg.reactions) msg.reactions = {};
        if (!msg.reactions[data.emoji]) msg.reactions[data.emoji] = { count: 0, users: [] };
        const r = msg.reactions[data.emoji];
        if (r.users.includes(data.userId)) {
          r.users = r.users.filter(u => u !== data.userId);
          r.count = r.users.length;
          if (r.count === 0) delete msg.reactions[data.emoji];
        } else {
          r.users.push(data.userId);
          r.count = r.users.length;
        }
        queueRender();
      }
      break;
    }
    case "edit": {
      const msg = state.messages.find(m => m.id === data.msgId);
      if (msg) { msg.content = data.content; msg.edited = true; queueRender(); }
      break;
    }
    case "delete": {
      state.messages = state.messages.filter(m => m.id !== data.msgId);
      queueRender();
      break;
    }
    case "peer-list": {
      // Another peer sharing their known peers for mesh expansion
      if (data.peers) {
        data.peers.forEach(p => {
          if (p.id !== state.peer?.id && !state.connections.has(p.id)) {
            connectToPeer(p.id);
          }
        });
      }
      break;
    }
  }
}

function setupConnection(conn) {
  const peerId = conn.peer;
  state.connections.set(peerId, { conn, user: null });

  conn.on("open", () => {
    conn.send(JSON.stringify({ type: "hello", user: state.me }));
    // Share known peers for mesh networking
    setTimeout(() => {
      const peers = [...state.connections.keys()].filter(id => id !== peerId);
      if (peers.length) conn.send(JSON.stringify({ type: "peer-list", peers: peers.map(id => ({ id })) }));
    }, 500);
    refreshPeerList();
    queueRender();
  });

  conn.on("data", (raw) => handleData(peerId, raw));

  conn.on("close", () => {
    const user = state.connections.get(peerId)?.user;
    state.connections.delete(peerId);
    if (user) addSystemMessage(`${user.name} left the room`);
    refreshPeerList();
    queueRender();
  });

  conn.on("error", () => {
    state.connections.delete(peerId);
    refreshPeerList();
    queueRender();
  });
}

function connectToPeer(peerId) {
  if (state.connections.has(peerId) || peerId === state.peer?.id) return;
  const conn = state.peer.connect(peerId, { reliable: true });
  setupConnection(conn);
}

function refreshPeerList() {
  state.peers = [];
  state.connections.forEach(({ user }, id) => {
    if (user) state.peers.push({ ...user, peerId: id, status: "online" });
  });
}

function addSystemMessage(text) {
  state.messages.push({ id: "sys-" + Date.now() + Math.random(), system: true, content: text, ts: Date.now() });
  queueRender();
  scrollToBottom();
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sendMessage(content) {
  if (!content.trim()) return;
  const msg = { id: state.me.id + "-" + Date.now(), userId: state.me.id, userName: state.me.name, userColor: state.me.color, userAvatar: state.me.avatar, content: content.trim(), ts: Date.now() };
  state.messages.push(msg);
  broadcast({ type: "message", msg });
  queueRender();
  scrollToBottom();
}

function sendTyping() {
  broadcast({ type: "typing", userId: state.me.id });
}

function toggleReaction(msgId, emoji) {
  const msg = state.messages.find(m => m.id === msgId);
  if (!msg) return;
  if (!msg.reactions) msg.reactions = {};
  if (!msg.reactions[emoji]) msg.reactions[emoji] = { count: 0, users: [] };
  const r = msg.reactions[emoji];
  if (r.users.includes(state.me.id)) {
    r.users = r.users.filter(u => u !== state.me.id);
    r.count = r.users.length;
    if (r.count === 0) delete msg.reactions[emoji];
  } else {
    r.users.push(state.me.id);
    r.count = r.users.length;
  }
  broadcast({ type: "reaction", msgId, emoji, userId: state.me.id });
  queueRender();
}

function editMessage(msgId, content) {
  const msg = state.messages.find(m => m.id === msgId);
  if (msg && msg.userId === state.me.id) { msg.content = content; msg.edited = true; broadcast({ type: "edit", msgId, content }); queueRender(); }
}

function deleteMessage(msgId) {
  const msg = state.messages.find(m => m.id === msgId);
  if (msg && msg.userId === state.me.id) { state.messages = state.messages.filter(m => m.id !== msgId); broadcast({ type: "delete", msgId }); queueRender(); }
}

// â”€â”€ Create / Join Room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createRoom(name, color) {
  const room = genRoomCode();
  const myId = genPeerId(room, Date.now().toString(36));
  state.me = { id: myId, name, color, avatar: name[0].toUpperCase() };
  state.roomCode = room;

  const peer = new Peer(myId);
  state.peer = peer;

  peer.on("open", () => {
    state.connected = true;
    state.screen = "chat";
    addSystemMessage("Room created! Share the code to invite others.");
    queueRender();
  });

  peer.on("connection", (conn) => setupConnection(conn));
  peer.on("error", (err) => { console.error("Peer error:", err); });
}

function joinRoom(name, color, roomCode) {
  const code = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, "");
  const myId = genPeerId(code, Date.now().toString(36));
  state.me = { id: myId, name, color, avatar: name[0].toUpperCase() };
  state.roomCode = code;

  const peer = new Peer(myId);
  state.peer = peer;

  peer.on("open", () => {
    state.connected = true;
    state.screen = "chat";
    queueRender();

    // Try connecting to potential peers in this room
    // We scan for the room creator by trying common patterns
    // The real connection happens when we get peer-list back
    // For now, we rely on the creator's peer ID being discoverable
    // Strategy: try to connect to any peer that shared this room code
  });

  peer.on("connection", (conn) => setupConnection(conn));
  peer.on("error", (err) => { console.error("Peer error:", err); });
}

// Better approach: use room code as a rendezvous point
function createRoomV2(name, color) {
  const room = genRoomCode();
  const myId = "nexus-" + room + "-host";
  state.me = { id: myId, name, color, avatar: name[0].toUpperCase() };
  state.roomCode = room;

  const peer = new Peer(myId);
  state.peer = peer;
  peer.on("open", () => { state.connected = true; state.screen = "chat"; addSystemMessage("Room created! Share code: " + room); queueRender(); });
  peer.on("connection", (conn) => setupConnection(conn));
  peer.on("error", (err) => { console.error("Peer error:", err); queueRender(); });
}

function joinRoomV2(name, color, roomCode) {
  const code = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, "");
  if (code.length < 4) return;
  const myId = "nexus-" + code + "-" + Date.now().toString(36);
  state.me = { id: myId, name, color, avatar: name[0].toUpperCase() };
  state.roomCode = code;

  const peer = new Peer(myId);
  state.peer = peer;
  peer.on("open", () => {
    state.connected = true;
    state.screen = "chat";
    queueRender();
    // Connect to the host
    connectToPeer("nexus-" + code + "-host");
  });
  peer.on("connection", (conn) => setupConnection(conn));
  peer.on("error", (err) => { console.error("Peer error:", err); queueRender(); });
}

function copyRoomCode() {
  navigator.clipboard?.writeText(state.roomCode).then(() => {
    state.copyToast = true; queueRender();
    setTimeout(() => { state.copyToast = false; queueRender(); }, 2000);
  });
}

// â”€â”€ Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollToBottom() {
  setTimeout(() => {
    const el = document.getElementById("msg-list");
    if (el) el.scrollTop = el.scrollHeight;
  }, 50);
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let editingId = null;
let hoverMsgId = null;
let emojiPickerMsgId = null;
let typingTimeout = null;

function render() {
  const app = document.getElementById("app");
  if (state.screen === "connect") {
    app.innerHTML = renderConnect();
    bindConnect();
  } else {
    app.innerHTML = renderChat();
    bindChat();
    scrollToBottom();
  }
}

function renderConnect() {
  return `
  <div class="connect-screen">
    <div class="connect-card">
      <h1>âš¡ NEXUS</h1>
      <p class="sub">Peer-to-peer chat. No servers. No accounts. Just vibes.</p>
      <label>YOUR NAME</label>
      <input id="name-input" placeholder="Enter your name" maxlength="20" autofocus value="">
      <label>PICK A COLOR</label>
      <div class="color-pick">
        ${COLORS.map((c, i) => `<div class="color-swatch ${i === 0 ? "active" : ""}" data-color="${c}" style="background:${c}"></div>`).join("")}
      </div>
      <button id="create-btn" class="btn-primary" disabled>Create Room</button>
      <div class="divider-text"><div class="line"></div>or join existing<div class="line"></div></div>
      <label>ROOM CODE</label>
      <input id="room-input" class="mono-input" placeholder="ABC123" maxlength="6">
      <button id="join-btn" class="btn-secondary" disabled>Join Room</button>
    </div>
  </div>`;
}

function bindConnect() {
  const nameInput = document.getElementById("name-input");
  const roomInput = document.getElementById("room-input");
  const createBtn = document.getElementById("create-btn");
  const joinBtn = document.getElementById("join-btn");
  let selectedColor = COLORS[0];

  function updateButtons() {
    const hasName = nameInput.value.trim().length > 0;
    createBtn.disabled = !hasName;
    joinBtn.disabled = !hasName || roomInput.value.replace(/[^A-Za-z0-9]/g, "").length < 4;
  }

  nameInput.addEventListener("input", updateButtons);
  roomInput.addEventListener("input", (e) => { e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, ""); updateButtons(); });

  document.querySelectorAll(".color-swatch").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".color-swatch").forEach(s => s.classList.remove("active"));
      el.classList.add("active");
      selectedColor = el.dataset.color;
    });
  });

  createBtn.addEventListener("click", () => { if (nameInput.value.trim()) createRoomV2(nameInput.value.trim(), selectedColor); });
  joinBtn.addEventListener("click", () => { if (nameInput.value.trim() && roomInput.value.length >= 4) joinRoomV2(nameInput.value.trim(), selectedColor, roomInput.value); });

  nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") createBtn.click(); });
  roomInput.addEventListener("keydown", (e) => { if (e.key === "Enter") joinBtn.click(); });
}

function renderChat() {
  const allUsers = [{ ...state.me, status: "online" }, ...state.peers];
  const onlineCount = allUsers.length;

  // Group messages by date
  let lastDate = "";
  let lastUser = "";
  let lastTs = 0;
  let msgHtml = "";

  for (const msg of state.messages) {
    const date = formatDate(msg.ts);
    if (date !== lastDate) {
      msgHtml += `<div class="date-divider"><div class="line"></div><span>${date}</span><div class="line"></div></div>`;
      lastDate = date;
      lastUser = "";
    }

    if (msg.system) {
      msgHtml += `<div style="padding:4px 16px;text-align:center;color:var(--fnt);font-size:12px;font-style:italic">${esc(msg.content)}</div>`;
      lastUser = "";
      continue;
    }

    const compact = msg.userId === lastUser && (msg.ts - lastTs) < 300000;
    const isOwn = msg.userId === state.me.id;
    const isHover = hoverMsgId === msg.id;

    // Reactions
    let reactionsHtml = "";
    if (msg.reactions && Object.keys(msg.reactions).length > 0) {
      reactionsHtml = '<div class="reactions">';
      for (const [emoji, data] of Object.entries(msg.reactions)) {
        const mine = data.users.includes(state.me.id) ? " mine" : "";
        reactionsHtml += `<button class="reaction${mine}" data-react-msg="${msg.id}" data-react-emoji="${emoji}">${emoji}<span>${data.count}</span></button>`;
      }
      reactionsHtml += "</div>";
    }

    if (compact) {
      msgHtml += `<div class="message compact msg-enter" data-msg-id="${msg.id}">
        <div class="msg-body">${esc(msg.content)}${msg.edited ? ' <span class="msg-edited">(edited)</span>' : ""}</div>
        ${reactionsHtml}
      </div>`;
    } else {
      msgHtml += `<div class="message msg-enter" data-msg-id="${msg.id}">
        <div class="peer-av" style="background:linear-gradient(135deg,${msg.userColor}30,${msg.userColor}10);border:2px solid ${msg.userColor}55;color:${msg.userColor};width:38px;height:38px;min-width:38px;font-size:14px">${esc(msg.userAvatar)}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:2px">
            <span class="msg-author" style="color:${msg.userColor}">${esc(msg.userName)}</span>
            <span class="msg-time">${formatTime(msg.ts)}</span>
            ${msg.edited ? '<span class="msg-edited">(edited)</span>' : ""}
          </div>
          <div class="msg-body">${esc(msg.content)}</div>
          ${reactionsHtml}
        </div>
      </div>`;
    }
    lastUser = msg.userId;
    lastTs = msg.ts;
  }

  // Typing indicator
  const typingNames = [...state.typing].map(id => {
    const p = state.peers.find(p => p.id === id);
    return p ? p.name : null;
  }).filter(Boolean);
  let typingHtml = "";
  if (typingNames.length) {
    typingHtml = `<span class="dot">â—</span><span class="dot" style="animation-delay:.15s">â—</span><span class="dot" style="animation-delay:.3s">â—</span> <strong>${typingNames.join(", ")}</strong> ${typingNames.length === 1 ? "is" : "are"} typingâ€¦`;
  }

  // Members
  let membersHtml = `<div class="mem-header">ONLINE â€” ${onlineCount}</div>`;
  for (const u of allUsers) {
    membersHtml += `<div class="peer-item">
      <div class="peer-av" style="background:linear-gradient(135deg,${u.color}30,${u.color}10);border:2px solid ${u.color}55;color:${u.color}"><div class="status" style="background:var(--grn)"></div>${esc(u.avatar)}</div>
      <div><div class="peer-name" style="color:${u.color}">${esc(u.name)}${u.id === state.me.id ? " (you)" : ""}</div><div class="peer-status">Online</div></div>
    </div>`;
  }

  return `
  ${state.copyToast ? '<div class="copy-toast">Room code copied!</div>' : ""}
  <div class="sidebar ${state.mobileSidebar ? "open" : ""}" id="sidebar">
    <div class="sb-header">
      <span style="font-size:20px">âš¡</span>
      <h2>NEXUS P2P</h2>
    </div>
    <div class="room-section">
      <div class="room-code" id="copy-code" title="Click to copy">
        <div>
          <div class="label">Room Code</div>
          <div class="code">${state.roomCode}</div>
        </div>
        <span style="font-size:16px;color:var(--mut)">ğŸ“‹</span>
      </div>
      <div style="font-size:11px;color:var(--fnt);text-align:center">Share this code so others can join</div>
    </div>
    <div style="padding:0 16px 8px"><div style="height:1px;background:var(--brd)"></div></div>
    <div style="padding:4px 16px 8px;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--fnt)">PEERS â€” ${onlineCount}</div>
    <div class="peer-list">
      ${allUsers.map(u => `<div class="peer-item">
        <div class="peer-av" style="background:linear-gradient(135deg,${u.color}30,${u.color}10);border:2px solid ${u.color}55;color:${u.color}"><div class="status" style="background:var(--grn)"></div>${esc(u.avatar)}</div>
        <div><div class="peer-name" style="color:${u.color}">${esc(u.name)}${u.id === state.me.id ? " <span style='color:var(--fnt);font-weight:400'>(you)</span>" : ""}</div></div>
      </div>`).join("")}
    </div>
    <div class="user-panel">
      <div class="peer-av" style="background:linear-gradient(135deg,${state.me.color}30,${state.me.color}10);border:2px solid ${state.me.color}55;color:${state.me.color};width:32px;height:32px;min-width:32px;font-size:12px"><div class="status" style="background:var(--grn)"></div>${esc(state.me.avatar)}</div>
      <div style="flex:1;min-width:0"><div class="name" style="color:${state.me.color}">${esc(state.me.name)}</div><div class="st">Connected â€¢ P2P</div></div>
    </div>
  </div>
  ${state.mobileSidebar ? '<div class="mobile-overlay" id="mobile-overlay"></div>' : ""}
  <div class="chat-area">
    <div class="chat-header">
      <button id="menu-btn" style="background:none;border:none;color:var(--mut);cursor:pointer;padding:4px;display:none" aria-label="Menu">â˜°</button>
      <span style="color:var(--mut);font-size:16px">ğŸ’¬</span>
      <h3>Room Chat</h3>
      <span class="topic">${onlineCount} peer${onlineCount !== 1 ? "s" : ""} connected â€¢ end-to-end encrypted</span>
      <button id="toggle-mem" style="background:none;border:none;color:${state.showMembers ? "var(--txt)" : "var(--mut)"};cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      </button>
    </div>
    <div class="msg-list" id="msg-list">
      <div class="msg-welcome">
        <div style="width:56px;height:56px;border-radius:28px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:12px">ğŸ”’</div>
        <h2>Peer-to-Peer Room</h2>
        <p>Messages are sent directly between peers. No servers, no storage, no tracking.</p>
      </div>
      ${msgHtml}
    </div>
    <div class="typing-bar">${typingHtml}</div>
    <div class="input-area">
      <div class="input-row">
        <input id="msg-input" placeholder="Send a messageâ€¦" autocomplete="off">
        <button id="send-btn" title="Send">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>
  ${state.showMembers ? `<div class="members-panel">${membersHtml}</div>` : ""}`;
}

function esc(s) {
  if (!s) return "";
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function bindChat() {
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const copyBtn = document.getElementById("copy-code");
  const toggleMem = document.getElementById("toggle-mem");
  const menuBtn = document.getElementById("menu-btn");
  const overlay = document.getElementById("mobile-overlay");

  // Show menu button on mobile
  if (window.innerWidth <= 600 && menuBtn) menuBtn.style.display = "flex";

  input?.focus();

  input?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(input.value); input.value = ""; }
    else {
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(sendTyping, 300);
    }
  });

  sendBtn?.addEventListener("click", () => { if (input?.value) { sendMessage(input.value); input.value = ""; input.focus(); } });
  copyBtn?.addEventListener("click", copyRoomCode);
  toggleMem?.addEventListener("click", () => { state.showMembers = !state.showMembers; queueRender(); });
  menuBtn?.addEventListener("click", () => { state.mobileSidebar = !state.mobileSidebar; queueRender(); });
  overlay?.addEventListener("click", () => { state.mobileSidebar = false; queueRender(); });

  // Bind reactions
  document.querySelectorAll("[data-react-msg]").forEach(btn => {
    btn.addEventListener("click", () => {
      toggleReaction(btn.dataset.reactMsg, btn.dataset.reactEmoji);
    });
  });

  // Hover actions on messages
  document.querySelectorAll(".message[data-msg-id]").forEach(el => {
    el.addEventListener("mouseenter", () => {
      const msgId = el.dataset.msgId;
      const msg = state.messages.find(m => m.id === msgId);
      if (!msg || msg.system) return;
      const isOwn = msg.userId === state.me.id;

      // Remove existing action bars
      document.querySelectorAll(".msg-actions").forEach(a => a.remove());
      document.querySelectorAll(".emoji-picker").forEach(a => a.remove());

      const actions = document.createElement("div");
      actions.className = "msg-actions";
      actions.innerHTML = `
        <button class="act-btn" data-action="react" title="React">ğŸ˜Š</button>
        ${isOwn ? '<button class="act-btn" data-action="edit" title="Edit">âœï¸</button>' : ""}
        ${isOwn ? '<button class="act-btn" data-action="delete" title="Delete">ğŸ—‘ï¸</button>' : ""}
      `;
      el.appendChild(actions);

      actions.querySelector('[data-action="react"]')?.addEventListener("click", (e) => {
        e.stopPropagation();
        document.querySelectorAll(".emoji-picker").forEach(a => a.remove());
        const picker = document.createElement("div");
        picker.className = "emoji-picker";
        picker.innerHTML = EMOJIS.map(e => `<button class="emoji-opt" data-emoji="${e}">${e}</button>`).join("");
        el.appendChild(picker);
        picker.querySelectorAll(".emoji-opt").forEach(btn => {
          btn.addEventListener("click", () => { toggleReaction(msgId, btn.dataset.emoji); });
        });
      });

      actions.querySelector('[data-action="edit"]')?.addEventListener("click", () => {
        const body = el.querySelector(".msg-body");
        if (!body) return;
        const old = msg.content;
        body.innerHTML = `<input class="edit-input" value="${esc(old).replace(/"/g, '&quot;')}" style="width:100%;background:var(--bg3);border:1px solid var(--brdL);border-radius:6px;padding:6px 10px;color:var(--txt);font-size:14px;font-family:var(--ff)"><div style="font-size:11px;color:var(--fnt);margin-top:4px">escape to cancel â€¢ enter to save</div>`;
        const inp = body.querySelector(".edit-input");
        inp.focus();
        inp.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { editMessage(msgId, inp.value); queueRender(); }
          if (e.key === "Escape") { queueRender(); }
        });
      });

      actions.querySelector('[data-action="delete"]')?.addEventListener("click", () => { deleteMessage(msgId); });
    });

    el.addEventListener("mouseleave", () => {
      el.querySelectorAll(".msg-actions").forEach(a => a.remove());
      el.querySelectorAll(".emoji-picker").forEach(a => a.remove());
    });
  });
}

// Keyboard shortcuts
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === "m") { e.preventDefault(); state.showMembers = !state.showMembers; queueRender(); }
  }
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
