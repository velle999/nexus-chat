<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS P2P</title>
<link rel="icon" type="image/png" href="assets/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.3/mqtt.min.js"></script>
<style>


*{box-sizing:border-box;margin:0;padding:0}
:root{--bg0:#06060e;--bg1:#0a0a14;--bg2:#0e0e1c;--bg3:#14142a;--bg4:#1a1a36;--brd:rgba(255,255,255,.06);--brdL:rgba(255,255,255,.1);--txt:#d0d0e8;--mut:#666688;--fnt:#444466;--acc:#00ffd5;--accD:rgba(0,255,213,.15);--red:#ff4466;--grn:#44ff88;--pink:#ff6bfa;--warn:#ffaa00;--ff:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace}
html,body{height:100%;overflow:hidden;background:var(--bg1);color:var(--txt);font-family:var(--ff)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
::selection{background:rgba(0,255,213,.2);color:#fff}
input,textarea{font-family:var(--ff)}input::placeholder{color:var(--fnt)}
input:focus,button:focus-visible{outline:2px solid rgba(0,255,213,.3);outline-offset:2px}
button:focus:not(:focus-visible){outline:none}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-4px);opacity:1}}
.msg-enter{animation:fadeIn .15s ease}
.dot{animation:typing 1s infinite;display:inline-block;font-size:8px}
#app{display:flex;height:100vh;width:100vw;overflow:hidden}
.sidebar{width:260px;min-width:260px;background:var(--bg2);display:flex;flex-direction:column;border-right:1px solid var(--brd);flex-shrink:0}
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.members-panel{width:220px;min-width:220px;background:var(--bg2);border-left:1px solid var(--brd);overflow-y:auto;flex-shrink:0}
.sb-header{padding:16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px}
.sb-header h2{font-size:16px;font-weight:800;color:#fff;font-family:var(--mono);letter-spacing:.5px}
.room-code-box{display:flex;align-items:center;gap:8px;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:10px 12px;cursor:pointer;transition:border-color .15s}
.room-code-box:hover{border-color:var(--acc)}
.copy-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--brdL);border-radius:8px;padding:8px 16px;color:var(--acc);font-size:13px;font-weight:600;z-index:999;animation:modalIn .15s ease;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.peer-av{width:34px;height:34px;min-width:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:14px;position:relative;flex-shrink:0}
.peer-av .st-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2.5px solid var(--bg2)}
.peer-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;transition:background .1s}
.peer-item:hover{background:rgba(255,255,255,.04)}
.user-panel{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg0);border-top:1px solid var(--brd)}
.chat-header{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--brd);min-height:50px;gap:8px}
.chat-header h3{font-size:15px;font-weight:700;color:#fff}
.msg-list{flex:1;overflow-y:auto;padding:0 0 8px}
.message{display:flex;gap:12px;padding:6px 16px;transition:background .1s;position:relative}
.message:hover{background:rgba(255,255,255,.03)}
.message.compact{padding:1px 16px 1px 62px}
.message.system{padding:4px 16px;justify-content:center}
.msg-author{font-weight:700;font-size:14px;font-family:var(--mono)}
.msg-time{color:var(--fnt);font-size:11px;font-family:var(--mono)}
.msg-body{color:var(--txt);font-size:14px;line-height:1.55;word-break:break-word}
.reactions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.reaction{background:rgba(255,255,255,.05);border:1px solid var(--brd);border-radius:10px;padding:2px 8px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:3px;transition:all .15s}
.reaction.mine{background:var(--accD);border-color:rgba(0,255,213,.3)}
.reaction span{font-family:var(--mono);font-size:11px}
.msg-actions{position:absolute;top:-4px;right:12px;display:none;gap:1px;background:var(--bg3);border-radius:6px;border:1px solid var(--brdL);padding:2px;z-index:5;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.message:hover .msg-actions{display:flex}
.act-btn{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:14px;background:none;border:none;color:var(--mut);transition:background .1s;line-height:1}
.act-btn:hover{background:rgba(255,255,255,.08)}
.emoji-picker{position:absolute;top:32px;right:0;display:flex;gap:2px;background:var(--bg3);border-radius:8px;border:1px solid var(--brdL);padding:6px;z-index:10;box-shadow:0 8px 24px rgba(0,0,0,.4);flex-wrap:wrap;width:200px}
.emoji-opt{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:20px;background:none;border:none;transition:background .1s}
.emoji-opt:hover{background:rgba(255,255,255,.08)}
.date-divider{display:flex;align-items:center;gap:8px;padding:16px 16px 4px}
.date-divider span{font-size:11px;font-weight:600;color:var(--mut);font-family:var(--mono);white-space:nowrap}
.date-divider .line{flex:1;height:1px;background:var(--brd)}
.input-area{padding:0 16px 14px;flex-shrink:0}
.input-row{display:flex;align-items:center;background:var(--bg3);border-radius:8px;border:1px solid var(--brd);padding:0 6px}
.input-row input{flex:1;background:transparent;border:none;color:var(--txt);font-size:14px;padding:12px 8px;min-width:0}
.send-btn{padding:8px;cursor:pointer;border-radius:4px;background:none;border:none;color:var(--fnt);font-size:14px;transition:color .15s;display:flex;align-items:center}
.send-btn:hover{color:var(--acc)}
.typing-bar{padding:4px 12px 2px;font-size:11px;color:var(--mut);min-height:20px}
.connect-screen{display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;background:var(--bg1)}
.connect-card{background:var(--bg2);border:1px solid var(--brdL);border-radius:16px;padding:40px;width:440px;max-width:90vw;text-align:center;animation:modalIn .3s ease;box-shadow:0 16px 48px rgba(0,0,0,.5)}
.connect-card h1{font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.connect-card .sub{color:var(--mut);font-size:14px;margin-bottom:32px}
.connect-card label{display:block;text-align:left;font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--mut);margin-bottom:8px}
.connect-card input{width:100%;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:12px 14px;color:var(--txt);font-size:14px;margin-bottom:16px}
.mono-input{font-family:var(--mono)!important;letter-spacing:2px;text-align:center;font-size:18px!important}
.btn-primary{width:100%;padding:12px 20px;border-radius:8px;background:var(--acc);color:var(--bg0);font-weight:700;font-size:15px;cursor:pointer;border:none;font-family:var(--ff);transition:opacity .15s;margin-bottom:10px}
.btn-primary:hover{opacity:.9}.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{width:100%;padding:12px 20px;border-radius:8px;background:transparent;color:var(--txt);font-weight:600;font-size:14px;cursor:pointer;border:1px solid var(--brd);font-family:var(--ff);transition:background .15s}
.btn-secondary:hover{background:rgba(255,255,255,.04)}.btn-secondary:disabled{opacity:.4;cursor:not-allowed}
.divider-text{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--fnt);font-size:12px;font-weight:600}
.divider-text .line{flex:1;height:1px;background:var(--brd)}
.color-pick{display:flex;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:14px;cursor:pointer;border:3px solid transparent;transition:border-color .15s,opacity .15s;opacity:.6}
.color-swatch.active{border-color:#fff;opacity:1}
.edit-input{width:100%;background:var(--bg3);border:1px solid var(--brdL);border-radius:6px;padding:6px 10px;color:var(--txt);font-size:14px;font-family:var(--ff)}
.mem-header{padding:14px 14px 6px;font-weight:700;font-size:11px;letter-spacing:1.5px;color:var(--mut)}
@media(max-width:900px){.members-panel{display:none}}
@media(max-width:600px){.sidebar{position:fixed;left:0;top:0;bottom:0;z-index:50;transform:translateX(-100%);transition:transform .2s}.sidebar.open{transform:translateX(0)}.mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40}.menu-btn{display:flex!important}}
.relay-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;font-family:var(--mono);padding:2px 8px;border-radius:10px;letter-spacing:.5px}
.relay-badge.p2p{color:var(--grn);background:rgba(68,255,136,.1);border:1px solid rgba(68,255,136,.2)}
.relay-badge.relay{color:var(--warn);background:rgba(255,170,0,.1);border:1px solid rgba(255,170,0,.2)}
.voice-bar{display:flex;align-items:center;gap:8px;padding:8px 16px;border-top:1px solid var(--brd);background:var(--bg3)}
.ptt-btn{width:48px;height:48px;border-radius:50%;border:2px solid var(--brd);background:var(--bg2);color:var(--mut);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;font-size:20px;-webkit-user-select:none;user-select:none}
.ptt-btn:hover{border-color:var(--acc);color:var(--acc)}
.ptt-btn.active{border-color:var(--red);background:rgba(255,68,102,.15);color:var(--red);animation:pttPulse 1s infinite}
.ptt-btn.disabled{opacity:.3;cursor:not-allowed}
@keyframes pttPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,68,102,.3)}50%{box-shadow:0 0 0 8px rgba(255,68,102,0)}}
.voice-info{flex:1;min-width:0}
.voice-status{font-size:11px;font-family:var(--mono);color:var(--mut)}
.voice-status.tx{color:var(--red)}
.voice-status.rx{color:var(--grn)}
.voice-viz{display:flex;align-items:end;gap:1px;height:20px}
.voice-viz .bar{width:3px;background:var(--acc);border-radius:1px;transition:height .05s}
.speaker-icon{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-family:var(--mono);color:var(--grn);padding:2px 6px;border-radius:8px;background:rgba(68,255,136,.08);animation:fadeIn .2s ease}
.file-msg{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg3);border:1px solid var(--brd);border-radius:10px;margin-top:4px;max-width:360px;cursor:pointer;transition:border-color .15s}
.file-msg:hover{border-color:var(--acc)}
.file-icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.file-icon.img{background:rgba(107,159,255,.12);color:#6b9fff}
.file-icon.doc{background:rgba(0,255,213,.12);color:var(--acc)}
.file-icon.vid{background:rgba(255,107,250,.12);color:var(--pink)}
.file-icon.aud{background:rgba(255,170,0,.12);color:var(--warn)}
.file-icon.gen{background:rgba(255,255,255,.06);color:var(--mut)}
.file-name{font-family:var(--mono);font-size:12px;font-weight:600;color:var(--txt);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-size{font-size:10px;color:var(--fnt);font-family:var(--mono)}
.file-img-preview{max-width:300px;max-height:200px;border-radius:8px;margin-top:6px;border:1px solid var(--brd)}
.gif-panel{position:absolute;bottom:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--brd);border-radius:12px 12px 0 0;max-height:360px;display:flex;flex-direction:column;box-shadow:0 -8px 32px rgba(0,0,0,.5);z-index:60;overflow:hidden}
.gif-search{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--brd)}
.gif-search input{flex:1;background:var(--bg3);border:1px solid var(--brd);border-radius:6px;color:var(--txt);font-size:13px;padding:8px 10px;font-family:var(--mono)}
.gif-search input::placeholder{color:var(--fnt)}
.gif-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;padding:8px;overflow-y:auto;flex:1}
.gif-grid img{width:100%;border-radius:6px;cursor:pointer;transition:transform .1s;display:block}
.gif-grid img:hover{transform:scale(1.03)}
.gif-grid .gif-loading{grid-column:1/-1;text-align:center;padding:24px;color:var(--fnt);font-size:12px;font-family:var(--mono)}
.gif-attr{padding:4px 12px 6px;text-align:right;font-size:9px;color:var(--fnt);font-family:var(--mono);border-top:1px solid var(--brd)}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEXUS P2P â€” WebRTC + MQTT Relay + Voice Chat
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS=["#00ffd5","#ff6bfa","#ffd000","#ff4466","#44ffaa","#6b9fff","#ff9944","#aa66ff"];
const EMOJIS=["ğŸ‘","ğŸ”¥","ğŸ’œ","ğŸ˜‚","ğŸš€","ğŸ‘€","â¤ï¸","ğŸ‰"];
const RC="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
function genCode(){let c="";for(let i=0;i<6;i++)c+=RC[Math.floor(Math.random()*RC.length)];return c}
function fmtTime(ts){return new Date(ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
function fmtDate(ts){const d=new Date(ts),n=new Date();if(n-d<86400000&&d.getDate()===n.getDate())return"Today";if(n-d<172800000)return"Yesterday";return d.toLocaleDateString([],{month:"short",day:"numeric"})}
function esc(s){if(!s)return"";const d=document.createElement("div");d.textContent=s;return d.innerHTML}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S={screen:"connect",me:null,roomCode:"",peer:null,mqtt:null,
  conns:new Map(),knownUsers:new Map(),messages:[],typing:new Map(),
  connected:false,showMembers:true,mobileSidebar:false,copyToast:false,
  peerError:null,diag:[],mode:"connecting",mqttReady:false,webrtcFailed:false,
  // Voice state
  voice:{joined:false,transmitting:false,micStream:null,recorder:null,
    audioCtx:null,speakers:new Map(),vizBars:[0,0,0,0,0,0,0,0]},
  // Encryption
  cryptoKey:null,
  // Persistence
  persist:false
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// E2E ENCRYPTION â€” AES-256-GCM with room code as shared secret
// Room code â†’ PBKDF2 â†’ AES key. All peers with the code can decrypt.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const E2E_SALT="nexus-p2p-e2e-v1";
const ENC=new TextEncoder(),DEC=new TextDecoder();

async function deriveRoomKey(roomCode){
  try{
    const keyMaterial=await crypto.subtle.importKey("raw",ENC.encode(roomCode),"PBKDF2",false,["deriveKey"]);
    const key=await crypto.subtle.deriveKey(
      {name:"PBKDF2",salt:ENC.encode(E2E_SALT),iterations:100000,hash:"SHA-256"},
      keyMaterial,
      {name:"AES-GCM",length:256},
      false,
      ["encrypt","decrypt"]
    );
    dlog("E2E: room key derived âœ“",true);
    return key;
  }catch(e){dlog("E2E: key derivation failed - "+e.message,false);return null}
}

async function e2eEncrypt(plaintext){
  if(!S.cryptoKey)return{_plain:true,d:plaintext};
  try{
    const iv=crypto.getRandomValues(new Uint8Array(12));
    const data=ENC.encode(JSON.stringify(plaintext));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},S.cryptoKey,data);
    // Encode as base64
    const ivB64=btoa(String.fromCharCode(...iv));
    const ctBytes=new Uint8Array(ct);
    let ctB64="";const C=8192;
    for(let i=0;i<ctBytes.length;i+=C){ctB64+=String.fromCharCode.apply(null,ctBytes.subarray(i,i+C))}
    ctB64=btoa(ctB64);
    return{_e:true,iv:ivB64,ct:ctB64};
  }catch(e){dlog("E2E encrypt error: "+e.message,false);return{_plain:true,d:plaintext}}
}

async function e2eDecrypt(envelope){
  // Unencrypted message (backward compat or hello)
  if(!envelope._e)return envelope._plain?envelope.d:envelope;
  if(!S.cryptoKey)return null;
  try{
    const iv=Uint8Array.from(atob(envelope.iv),c=>c.charCodeAt(0));
    const raw=atob(envelope.ct);
    const ctBytes=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)ctBytes[i]=raw.charCodeAt(i);
    const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},S.cryptoKey,ctBytes);
    return JSON.parse(DEC.decode(pt));
  }catch(e){dlog("E2E decrypt error: "+e.message,false);return null}
}

// â”€â”€ Diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dlog(msg,ok){
  const t=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  S.diag.push({t,msg,ok});if(S.diag.length>50)S.diag.shift();
  console.log("[NEXUS]",ok===true?"âœ“":ok===false?"âœ—":"â€¢",msg);
  const el=document.getElementById("diag-log");
  if(el){el.innerHTML=S.diag.map(d=>'<div style="color:'+(d.ok===true?"var(--grn)":d.ok===false?"var(--red)":"var(--mut)")+'"><span style="opacity:.5">'+d.t+'</span> '+(d.ok===true?"âœ“ ":d.ok===false?"âœ— ":"â€¢ ")+esc(d.msg)+'</div>').join("");el.scrollTop=el.scrollHeight}
}

let renderQ=false,currentScreen=null;
function qr(){if(!renderQ){renderQ=true;requestAnimationFrame(doRender)}}

// â”€â”€ Notification Sound (WebAudio oscillator) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let notifCtx=null;
function playNotif(){
  try{
    if(!notifCtx)notifCtx=new(window.AudioContext||window.webkitAudioContext)();
    const t=notifCtx.currentTime;
    // Two-tone chime: ascending notes
    const g=notifCtx.createGain();
    g.connect(notifCtx.destination);
    g.gain.setValueAtTime(0.15,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
    // First tone
    const o1=notifCtx.createOscillator();
    o1.type="sine";o1.frequency.setValueAtTime(880,t);
    o1.connect(g);o1.start(t);o1.stop(t+0.15);
    // Second tone (higher)
    const g2=notifCtx.createGain();
    g2.connect(notifCtx.destination);
    g2.gain.setValueAtTime(0,t);
    g2.gain.setValueAtTime(0.12,t+0.1);
    g2.gain.exponentialRampToValueAtTime(0.001,t+0.35);
    const o2=notifCtx.createOscillator();
    o2.type="sine";o2.frequency.setValueAtTime(1320,t+0.1);
    o2.connect(g2);o2.start(t+0.1);o2.stop(t+0.35);
  }catch(e){}
}

// â”€â”€ ICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ICE_SERVERS=[
  {urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},
  {urls:"stun:stun.cloudflare.com:3478"},{urls:"stun:freestun.net:3478"},
  {urls:"turn:freestun.net:3478",username:"free",credential:"free"},
  {urls:"turn:freestun.net:5349",username:"free",credential:"free"},
  {urls:"turns:freestun.net:5349",username:"free",credential:"free"}
];
(async()=>{try{const r=await fetch("https://speed.cloudflare.com/turn-creds");if(!r.ok)return;const d=await r.json();if(d.username&&d.credential){dlog("Cloudflare TURN OK",true);ICE_SERVERS.push({urls:"turn:turn.speed.cloudflare.com:50000",username:d.username,credential:d.credential},{urls:"turns:turn.speed.cloudflare.com:443?transport=tcp",username:d.username,credential:d.credential})}}catch(e){dlog("CF TURN: "+e.message,false)}})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MQTT RELAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MQTT_BROKER="wss://broker.hivemq.com:8884/mqtt";
function mqttTopic(room,sub){return"nexus/"+room+"/"+sub}

function startMqtt(room){
  dlog("Connecting to MQTT relay...");
  const cid="nexus-"+Math.random().toString(36).slice(2,10);
  try{
    const client=mqtt.connect(MQTT_BROKER,{clientId:cid,clean:true,connectTimeout:8000,keepalive:30,protocolVersion:4});
    S.mqtt=client;
    client.on("connect",()=>{
      dlog("MQTT connected!",true);S.mqttReady=true;
      client.subscribe(mqttTopic(room,"msg"));
      client.subscribe(mqttTopic(room,"voice"));
      mqttSend({type:"hello",user:S.me});
      if(S.webrtcFailed&&S.mode!=="relay"){S.mode="relay";sysMsg("Connected via relay (WebSocket)");qr()}
    });
    client.on("message",async(topic,payload)=>{
      try{
        const envelope=JSON.parse(payload.toString());
        const data=await e2eDecrypt(envelope);
        if(!data)return;
        if(topic.endsWith("/voice")){
          if(data._sender!==S.me?.id)handleVoiceRelay(data);
          return;
        }
        if(data._sender===S.me?.id)return;
        handleRelayMsg(data);
      }catch(e){}
    });
    client.on("error",e=>{dlog("MQTT error: "+e.message,false)});
    client.on("close",()=>{S.mqttReady=false});
  }catch(e){dlog("MQTT init fail: "+e.message,false)}
}

async function mqttSend(data){if(!S.mqtt||!S.mqttReady||!S.roomCode)return;data._sender=S.me.id;try{const enc=await e2eEncrypt(data);S.mqtt.publish(mqttTopic(S.roomCode,"msg"),JSON.stringify(enc))}catch(e){}}
async function mqttSendVoice(data){if(!S.mqtt||!S.mqttReady||!S.roomCode)return;data._sender=S.me.id;try{const enc=await e2eEncrypt(data);S.mqtt.publish(mqttTopic(S.roomCode,"voice"),JSON.stringify(enc))}catch(e){}}

function handleRelayMsg(data){
  switch(data.type){
    case"hello":{const uid=data.user?.id;if(!uid||uid===S.me?.id)break;if(!S.knownUsers.has(uid)){S.knownUsers.set(uid,data.user);sysMsg(data.user.name+" connected");mqttSend({type:"hello",user:S.me});if(S.messages.length)mqttSend({type:"sync",messages:stripFilesForSync(S.messages)})}qr();break}
    case"sync":{const have=new Set(S.messages.map(m=>m.id));const nu=(data.messages||[]).filter(m=>!have.has(m.id));if(nu.length){S.messages.push(...nu);S.messages.sort((a,b)=>a.ts-b.ts);qr();scrollBot()}break}
    case"message":{if(!S.messages.find(m=>m.id===data.msg?.id)){S.messages.push(data.msg);S.typing.delete(data.msg?.userId);playNotif();qr();scrollBot()}break}
    case"typing":{const uid=data.userId;if(!uid||uid===S.me?.id)break;if(S.typing.has(uid))clearTimeout(S.typing.get(uid));S.typing.set(uid,setTimeout(()=>{S.typing.delete(uid);qr()},3000));qr();break}
    case"reaction":{const msg=S.messages.find(m=>m.id===data.msgId);if(!msg)break;if(!msg.reactions)msg.reactions={};if(!msg.reactions[data.emoji])msg.reactions[data.emoji]={count:0,users:[]};const r=msg.reactions[data.emoji],idx=r.users.indexOf(data.userId);if(idx>=0){r.users.splice(idx,1);r.count--;if(r.count<=0)delete msg.reactions[data.emoji]}else{r.users.push(data.userId);r.count++}qr();break}
    case"edit":{const msg=S.messages.find(m=>m.id===data.msgId);if(msg){msg.content=data.content;msg.edited=true;qr()}break}
    case"delete":{S.messages=S.messages.filter(m=>m.id!==data.msgId);qr();break}
    case"leave":{S.knownUsers.delete(data.userId);if(data.userName)sysMsg(data.userName+" left");qr();break}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENT ROOMS â€” IndexedDB storage, rooms last 10 days while active
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IDB_NAME="nexus-p2p",IDB_VER=1,PERSIST_DAYS=10;
let idb=null;

function openIDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(IDB_NAME,IDB_VER);
    req.onupgradeneeded=(e)=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains("rooms")){db.createObjectStore("rooms",{keyPath:"code"})}
      if(!db.objectStoreNames.contains("messages")){const ms=db.createObjectStore("messages",{keyPath:"id"});ms.createIndex("room","room")}
    };
    req.onsuccess=()=>{idb=req.result;resolve(idb)};
    req.onerror=()=>reject(req.error);
  });
}

async function persistSave(){
  if(!S.persist||!idb||!S.roomCode)return;
  try{
    const tx=idb.transaction(["rooms","messages"],"readwrite");
    // Update room activity
    tx.objectStore("rooms").put({code:S.roomCode,lastActive:Date.now()});
    // Save all non-system messages
    const ms=tx.objectStore("messages");
    for(const m of S.messages){
      if(!m.system)ms.put({id:m.id,room:S.roomCode,...m});
    }
  }catch(e){dlog("Persist save error: "+e.message,false)}
}

async function persistLoad(roomCode){
  if(!idb)return[];
  try{
    return new Promise((resolve)=>{
      const tx=idb.transaction("messages","readonly");
      const idx=tx.objectStore("messages").index("room");
      const req=idx.getAll(roomCode);
      req.onsuccess=()=>{
        const msgs=(req.result||[]).map(r=>{const{room,...msg}=r;return msg}).sort((a,b)=>a.ts-b.ts);
        resolve(msgs);
      };
      req.onerror=()=>resolve([]);
    });
  }catch(e){return[]}
}

async function persistDeleteMsg(msgId){
  if(!S.persist||!idb)return;
  try{idb.transaction("messages","readwrite").objectStore("messages").delete(msgId)}catch(e){}
}

async function persistCleanExpired(){
  if(!idb)return;
  try{
    const cutoff=Date.now()-PERSIST_DAYS*86400000;
    const tx=idb.transaction(["rooms","messages"],"readwrite");
    const rooms=tx.objectStore("rooms");
    const msgs=tx.objectStore("messages");
    const req=rooms.getAll();
    req.onsuccess=()=>{
      for(const r of req.result||[]){
        if(r.lastActive<cutoff){
          rooms.delete(r.code);
          // Delete all messages for this room
          const idx=msgs.index("room");
          const mreq=idx.getAllKeys(r.code);
          mreq.onsuccess=()=>{for(const k of mreq.result||[])msgs.delete(k)};
        }
      }
    };
  }catch(e){}
}

// Auto-save every 5 seconds when persist is on
setInterval(()=>{if(S.persist&&S.screen==="chat")persistSave()},5000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function safeSend(c,d){try{if(c?.open){const enc=await e2eEncrypt(d);c.send(JSON.stringify(enc));return true}}catch(e){dlog("Send error: "+e.message,false)}return false}
async function broadcast(data){
  if(S.mode==="relay"){await mqttSend(data)}
  else{
    const enc=await e2eEncrypt(data);
    const json=JSON.stringify(enc);
    const tooBigForRTC=json.length>16000000;
    if(!tooBigForRTC){S.conns.forEach(({conn})=>{try{if(conn?.open)conn.send(json)}catch(e){}})}
    if(S.mqttReady){
      const plainJson=JSON.stringify(data);
      if(plainJson.length>600000&&data.type==="message"&&data.msg?.file?.data){
        const lite={...data,msg:{...data.msg,file:{...data.msg.file,data:null,stripped:true}}};
        await mqttSend(lite);
      }else{await mqttSend(data)}
    }
  }
}
function getPeers(){
  const r=[];
  S.conns.forEach(({user},id)=>{if(user)r.push({...user,peerId:id})});
  S.knownUsers.forEach((user,id)=>{if(id!==S.me?.id&&!r.find(p=>p.id===user.id))r.push({...user,peerId:id})});
  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBRTC (PeerJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let iceFailTimer=null;
function setup(conn,isInit){
  const pid=conn.peer;const short=pid.slice(-8);
  dlog("WebRTC setup ..."+short+" (init:"+isInit+")");
  if(S.conns.has(pid)){const ex=S.conns.get(pid);if(ex.conn?.open){conn.close();return}S.conns.delete(pid)}
  const e={conn,user:null,ready:false,helloed:false};S.conns.set(pid,e);
  conn.on("open",()=>{dlog("DataChannel OPEN ..."+short,true);e.ready=true;S.mode="p2p";S.webrtcFailed=false;if(iceFailTimer){clearTimeout(iceFailTimer);iceFailTimer=null}if(isInit){safeSend(conn,{type:"hello",user:S.me});e.helloed=true}qr()});
  conn.on("data",async raw=>{let envelope;try{envelope=typeof raw==="string"?JSON.parse(raw):(raw&&typeof raw==="object"?raw:null)}catch{return}if(!envelope)return;const d=await e2eDecrypt(envelope);if(d)onWebRTCMsg(pid,d)});
  conn.on("close",()=>{dlog("Closed ..."+short,false);const u=S.conns.get(pid)?.user;S.conns.delete(pid);if(u)sysMsg(u.name+" left");qr()});
  conn.on("error",()=>{S.conns.delete(pid);qr()});
  try{setTimeout(()=>{const pc=conn.peerConnection||conn._peerConnection;if(pc){
    pc.oniceconnectionstatechange=()=>{const st=pc.iceConnectionState;dlog("ICE: "+st,st==="connected"||st==="completed"?true:st==="failed"?false:undefined);if(st==="failed"){S.webrtcFailed=true;if(S.mqttReady){S.mode="relay";sysMsg("Switched to relay");qr()}}if(st==="connected"||st==="completed"){S.mode="p2p";qr()}};
    pc.onicecandidate=ev=>{if(ev.candidate)dlog("ICE: "+ev.candidate.type+" "+ev.candidate.protocol)};
  }},100)}catch(err){}
}
function connectTo(pid){if(S.conns.has(pid)||pid===S.peer?.id)return;setup(S.peer.connect(pid,{reliable:true}),true)}

function onWebRTCMsg(from,data){
  switch(data.type){
    case"hello":{const e=S.conns.get(from);if(!e)break;e.user=data.user;S.knownUsers.set(from,data.user);if(!e.helloed){safeSend(e.conn,{type:"hello",user:S.me});e.helloed=true;if(S.messages.length)safeSend(e.conn,{type:"sync",messages:stripFilesForSync(S.messages)})}setTimeout(()=>{const ids=[...S.conns.keys()].filter(id=>id!==from);if(ids.length)safeSend(e.conn,{type:"peers",ids})},800);sysMsg(data.user.name+" connected");qr();break}
    case"sync":{const have=new Set(S.messages.map(m=>m.id));const nu=(data.messages||[]).filter(m=>!have.has(m.id));if(nu.length){S.messages.push(...nu);S.messages.sort((a,b)=>a.ts-b.ts);qr();scrollBot()}break}
    case"message":{if(!S.messages.find(m=>m.id===data.msg?.id)){S.messages.push(data.msg);S.typing.delete(data.msg?.userId);playNotif();qr();scrollBot()}break}
    case"typing":{const uid=data.userId||from;if(S.typing.has(uid))clearTimeout(S.typing.get(uid));S.typing.set(uid,setTimeout(()=>{S.typing.delete(uid);qr()},3000));qr();break}
    case"reaction":{const msg=S.messages.find(m=>m.id===data.msgId);if(!msg)break;if(!msg.reactions)msg.reactions={};if(!msg.reactions[data.emoji])msg.reactions[data.emoji]={count:0,users:[]};const r=msg.reactions[data.emoji],idx=r.users.indexOf(data.userId);if(idx>=0){r.users.splice(idx,1);r.count--;if(r.count<=0)delete msg.reactions[data.emoji]}else{r.users.push(data.userId);r.count++}qr();break}
    case"edit":{const msg=S.messages.find(m=>m.id===data.msgId);if(msg){msg.content=data.content;msg.edited=true;qr()}break}
    case"delete":{S.messages=S.messages.filter(m=>m.id!==data.msgId);qr();break}
    case"peers":{(data.ids||[]).forEach(id=>{if(id!==S.peer?.id&&!S.conns.has(id))setTimeout(()=>connectTo(id),200+Math.random()*500)});break}
    case"voice":{handleVoiceRelay(data);break}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE ENGINE â€” Push-to-Talk
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function voiceJoin(){
  if(S.voice.joined)return;
  try{
    S.voice.micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    S.voice.audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    // Set up analyser for viz
    S.voice.analyser=S.voice.audioCtx.createAnalyser();
    S.voice.analyser.fftSize=32;
    const src=S.voice.audioCtx.createMediaStreamSource(S.voice.micStream);
    src.connect(S.voice.analyser);
    S.voice.joined=true;
    // Mute tracks until PTT pressed
    S.voice.micStream.getAudioTracks().forEach(t=>t.enabled=false);
    dlog("Voice: mic ready",true);
    sysMsg("Joined voice chat â€” hold ğŸ¤ or Space to talk");
    qr();
  }catch(e){dlog("Voice: mic error - "+e.message,false);sysMsg("Mic access denied")}
}

function voiceLeave(){
  if(!S.voice.joined)return;
  voiceStopTx();
  S.voice.micStream?.getTracks().forEach(t=>t.stop());
  S.voice.micStream=null;
  S.voice.audioCtx?.close();
  S.voice.audioCtx=null;
  S.voice.joined=false;
  S.voice.speakers.clear();
  sysMsg("Left voice chat");
  qr();
}

let vizFrame=0;
function voiceStartTx(){
  if(!S.voice.joined||S.voice.transmitting)return;
  S.voice.transmitting=true;
  S.voice.micStream.getAudioTracks().forEach(t=>t.enabled=true);
  // Collect all chunks during PTT hold, send complete audio on release
  S.voice.chunks=[];
  try{
    const opts=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?{mimeType:"audio/webm;codecs=opus",bitsPerSecond:24000}:{bitsPerSecond:24000};
    const mr=new MediaRecorder(S.voice.micStream,opts);
    S.voice.recorder=mr;
    mr.ondataavailable=(ev)=>{if(ev.data.size>0)S.voice.chunks.push(ev.data)};
    mr.onstop=async()=>{
      if(S.voice.chunks.length===0)return;
      const blob=new Blob(S.voice.chunks,{type:mr.mimeType||"audio/webm;codecs=opus"});
      S.voice.chunks=[];
      // Only send if reasonable size (< 500KB for a PTT clip)
      if(blob.size>500000){dlog("Voice clip too large: "+Math.round(blob.size/1024)+"KB",false);return}
      const buf=await blob.arrayBuffer();
      const bytes=new Uint8Array(buf);
      // Safe base64 encode (chunked to avoid stack overflow)
      let b64="";const CHUNK=8192;
      for(let i=0;i<bytes.length;i+=CHUNK){b64+=String.fromCharCode.apply(null,bytes.subarray(i,i+CHUNK))}
      b64=btoa(b64);
      const pkt={type:"voice",userId:S.me.id,userName:S.me.name,audio:b64,mime:mr.mimeType||"audio/webm",ts:Date.now()};
      if(S.mode==="p2p"){S.conns.forEach(({conn})=>safeSend(conn,pkt))}
      mqttSendVoice(pkt);
    };
    mr.start(100); // Collect in 100ms chunks, but send all together on stop
  }catch(e){dlog("Voice: recorder fail - "+e.message,false)}
  // Viz animation
  function vizLoop(){
    if(!S.voice.transmitting)return;
    if(S.voice.analyser){
      const data=new Uint8Array(S.voice.analyser.frequencyBinCount);
      S.voice.analyser.getByteFrequencyData(data);
      S.voice.vizBars=Array.from(data.slice(0,8)).map(v=>Math.max(2,v/255*20));
      const vel=document.getElementById("voice-viz");
      if(vel)vel.innerHTML=S.voice.vizBars.map(h=>'<div class="bar" style="height:'+h+'px"></div>').join("");
    }
    vizFrame=requestAnimationFrame(vizLoop);
  }
  vizLoop();
  qr();
}

function voiceStopTx(){
  if(!S.voice.transmitting)return;
  S.voice.transmitting=false;
  S.voice.micStream?.getAudioTracks().forEach(t=>t.enabled=false);
  // Stop recorder â€” this triggers onstop which sends the complete clip
  if(S.voice.recorder&&S.voice.recorder.state!=="inactive"){try{S.voice.recorder.stop()}catch(e){}}
  S.voice.recorder=null;
  cancelAnimationFrame(vizFrame);
  S.voice.vizBars=[0,0,0,0,0,0,0,0];
  const vel=document.getElementById("voice-viz");
  if(vel)vel.innerHTML=S.voice.vizBars.map(()=>'<div class="bar" style="height:2px"></div>').join("");
  qr();
}

// Receive and play voice data
function handleVoiceRelay(data){
  if(!S.voice.joined||!data.audio||data.userId===S.me?.id)return;
  S.voice.speakers.set(data.userId,{name:data.userName,ts:Date.now()});
  qr();
  // Decode complete audio clip and play
  try{
    const raw=atob(data.audio);
    const bytes=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
    const blob=new Blob([bytes],{type:data.mime||"audio/webm;codecs=opus"});
    const url=URL.createObjectURL(blob);
    const audio=new Audio(url);
    audio.volume=1.0;
    audio.onended=()=>{URL.revokeObjectURL(url);S.voice.speakers.delete(data.userId);qr()};
    audio.onerror=()=>{URL.revokeObjectURL(url);S.voice.speakers.delete(data.userId)};
    audio.play().catch(e=>{dlog("Voice playback fail: "+e.message,false)});
  }catch(e){dlog("Voice decode fail: "+e.message,false)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE SHARING â€” files sent as base64 chunks via both transports
// Max ~5MB via WebRTC, ~200KB via MQTT relay (chunked)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_FILE_RELAY=500*1024; // 500KB raw for MQTT
const MAX_FILE_P2P=25*1024*1024; // 25MB for WebRTC
const FILE_ICONS={gif:"ğŸï¸",image:"ğŸ–¼ï¸",video:"ğŸ¬",audio:"ğŸµ",pdf:"ğŸ“„",zip:"ğŸ“¦",code:"ğŸ’»",doc:"ğŸ“",default:"ğŸ“"};

function fileCategory(name,mime){
  if(mime?.startsWith("image/gif")||name?.toLowerCase().endsWith(".gif"))return"gif";
  if(mime?.startsWith("image/"))return"image";
  if(mime?.startsWith("video/"))return"video";
  if(mime?.startsWith("audio/"))return"audio";
  const ext=(name||"").split(".").pop()?.toLowerCase();
  if(["pdf"].includes(ext))return"pdf";
  if(["zip","rar","7z","tar","gz"].includes(ext))return"zip";
  if(["js","ts","py","html","css","json","md","sh","c","cpp","java","rs"].includes(ext))return"code";
  if(["doc","docx","txt","rtf","odt"].includes(ext))return"doc";
  return"default";
}
function fileIcon(cat){return FILE_ICONS[cat]||FILE_ICONS.default}
function fileIconClass(cat){return{gif:"img",image:"img",video:"vid",audio:"aud",pdf:"doc",zip:"gen",code:"doc",doc:"doc",default:"gen"}[cat]||"gen"}
function fmtSize(b){if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";return(b/1048576).toFixed(1)+" MB"}

// Safe base64 encode for large arrays (avoids stack overflow)
function toBase64(uint8){let b="";const C=8192;for(let i=0;i<uint8.length;i+=C){b+=String.fromCharCode.apply(null,uint8.subarray(i,i+C))}return btoa(b)}

// Strip large file data from messages for sync (keeps metadata, removes base64 blob)
function stripFilesForSync(msgs){
  return msgs.filter(m=>!m.system).map(m=>{
    if(m.file&&m.file.data){return{...m,file:{...m.file,data:null,stripped:true}}}
    return m;
  });
}

async function sendFile(file){
  const maxSize=S.mode==="p2p"?MAX_FILE_P2P:MAX_FILE_RELAY;
  if(file.size>maxSize){
    sysMsg("File too large ("+fmtSize(file.size)+"). Max "+fmtSize(maxSize)+" in "+(S.mode==="p2p"?"P2P":"relay")+" mode.");
    return;
  }
  try{
    const cat=fileCategory(file.name,file.type);
    const buf=await file.arrayBuffer();
    const b64=toBase64(new Uint8Array(buf));
    dlog("File: "+file.name+" ("+fmtSize(file.size)+") b64:"+Math.round(b64.length/1024)+"KB");

    const msg={
      id:S.me.id+"-"+Date.now()+"-"+Math.random().toString(36).slice(2,6),
      userId:S.me.id,userName:S.me.name,userColor:S.me.color,userAvatar:S.me.avatar,
      content:"",ts:Date.now(),
      file:{name:file.name,size:file.size,type:file.type,cat,data:b64}
    };

    if((cat==="image"||cat==="gif")&&file.size<MAX_FILE_P2P){
      msg.file.isImage=true;
    }

    S.messages.push(msg);
    broadcast({type:"message",msg});
    qr();scrollBot();
  }catch(e){
    dlog("File send error: "+e.message,false);
    sysMsg("Failed to send file: "+e.message);
  }
}

function downloadFile(msgId){
  const msg=S.messages.find(m=>m.id===msgId);
  if(!msg?.file?.data)return;
  try{
    const raw=atob(msg.file.data);
    const bytes=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
    const blob=new Blob([bytes],{type:msg.file.type||"application/octet-stream"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download=msg.file.name||"file";
    document.body.appendChild(a);a.click();
    setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url)},200);
  }catch(e){dlog("Download error: "+e.message,false)}
}

function renderFileMsg(msg){
  const f=msg.file;if(!f)return"";
  const cat=f.cat||fileCategory(f.name,f.type);
  const icon=fileIcon(cat);
  const cls=fileIconClass(cat);
  const canDownload=f.data&&!f.stripped;
  let html='<div class="file-msg"'+(canDownload?' onclick="downloadFile(\''+msg.id+'\')" title="Click to download" style="cursor:pointer"':' title="File shared in earlier session" style="cursor:default;opacity:.7"')+'>';
  html+='<div class="file-icon '+cls+'">'+icon+'</div>';
  html+='<div style="flex:1;min-width:0"><div class="file-name">'+esc(f.name)+'</div>';
  html+='<div class="file-size">'+fmtSize(f.size)+(canDownload?' â€¢ Click to download':' â€¢ No longer available')+'</div></div></div>';
  if(canDownload&&f.isImage&&f.data){
    html+='<img class="file-img-preview" src="data:'+(f.type||"image/png")+';base64,'+f.data+'" alt="'+esc(f.name)+'">';
  }
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GIPHY INTEGRATION â€” search and send GIFs via URL
// Uses GIPHY v1 API. Replace GIPHY_KEY with your own from developers.giphy.com
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GIPHY_KEY="Z1OROJGx4xxlT3DrNodF4mzjbsm00Lwx"; // Public beta key â€” get your own at developers.giphy.com
let gifPanelOpen=false,gifSearchTimer=null;

function toggleGifPanel(){
  const existing=document.getElementById("gif-panel");
  if(existing){existing.remove();gifPanelOpen=false;return}
  gifPanelOpen=true;
  const panel=document.createElement("div");
  panel.id="gif-panel";panel.className="gif-panel";
  panel.innerHTML='<div class="gif-search"><input id="gif-search-in" placeholder="Search GIFs..." autofocus><button id="gif-close" style="background:none;border:none;color:var(--mut);cursor:pointer;font-size:16px;padding:4px">âœ•</button></div><div class="gif-grid" id="gif-grid"><div class="gif-loading">Loading trending...</div></div><div class="gif-attr">Powered by GIPHY</div>';
  const inputArea=document.querySelector(".input-area");
  if(inputArea){inputArea.style.position="relative";inputArea.insertBefore(panel,inputArea.firstChild)}
  document.getElementById("gif-close")?.addEventListener("click",()=>{panel.remove();gifPanelOpen=false});
  const searchIn=document.getElementById("gif-search-in");
  searchIn?.addEventListener("input",()=>{
    clearTimeout(gifSearchTimer);
    gifSearchTimer=setTimeout(()=>{
      const q=searchIn.value.trim();
      if(q)searchGiphy(q);else loadTrendingGifs();
    },400);
  });
  searchIn?.addEventListener("keydown",e=>{if(e.key==="Escape"){panel.remove();gifPanelOpen=false}});
  loadTrendingGifs();
}

async function giphyFetch(url){
  const grid=document.getElementById("gif-grid");
  try{
    const r=await fetch(url);
    if(!r.ok){
      const errText=await r.text().catch(()=>"");
      if(grid)grid.innerHTML='<div class="gif-loading">API error ('+r.status+'). Get a free key at<br><a href="https://developers.giphy.com" target="_blank" style="color:var(--acc)">developers.giphy.com</a><br>and replace GIPHY_KEY in the code.</div>';
      dlog("GIPHY API error: "+r.status+" "+errText.slice(0,100),false);
      return null;
    }
    const d=await r.json();
    return d.data||[];
  }catch(e){
    if(grid)grid.innerHTML='<div class="gif-loading">Network error: '+esc(e.message)+'</div>';
    dlog("GIPHY fetch error: "+e.message,false);
    return null;
  }
}

async function loadTrendingGifs(){
  const grid=document.getElementById("gif-grid");
  if(!grid)return;
  grid.innerHTML='<div class="gif-loading">Loading trending...</div>';
  const gifs=await giphyFetch("https://api.giphy.com/v1/gifs/trending?api_key="+GIPHY_KEY+"&limit=20&rating=pg-13&bundle=low_bandwidth");
  if(gifs)renderGifResults(gifs);
}

async function searchGiphy(query){
  const grid=document.getElementById("gif-grid");
  if(!grid)return;
  grid.innerHTML='<div class="gif-loading">Searching...</div>';
  const gifs=await giphyFetch("https://api.giphy.com/v1/gifs/search?api_key="+GIPHY_KEY+"&q="+encodeURIComponent(query)+"&limit=20&rating=pg-13&bundle=low_bandwidth");
  if(gifs)renderGifResults(gifs);
}

function renderGifResults(gifs){
  const grid=document.getElementById("gif-grid");
  if(!grid)return;
  if(!gifs.length){grid.innerHTML='<div class="gif-loading">No results</div>';return}
  grid.innerHTML=gifs.map(g=>{
    const imgs=g.images||{};
    const preview=imgs.fixed_height_small?.url||imgs.fixed_width_small?.url||imgs.preview_gif?.url||imgs.fixed_height?.url||"";
    const full=imgs.original?.url||imgs.downsized_medium?.url||imgs.fixed_height?.url||preview;
    if(!preview)return"";
    return'<img src="'+esc(preview)+'" data-full="'+esc(full)+'" alt="'+esc(g.title||"GIF")+'" loading="lazy">';
  }).join("");
  grid.querySelectorAll("img").forEach(img=>{
    img.addEventListener("click",()=>{
      const url=img.dataset.full;
      if(url)sendMsg(url);
      const panel=document.getElementById("gif-panel");
      if(panel){panel.remove();gifPanelOpen=false}
    });
  });
}

// â”€â”€ Text Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IMG_URL_RE=/^(https?:\/\/\S+\.(?:gif|png|jpg|jpeg|webp)(?:\?\S*)?)$/i;
const IMG_URL_INLINE_RE=/(https?:\/\/\S+\.(?:gif|png|jpg|jpeg|webp)(?:\?\S*)?)/gi;

function renderContent(text){
  if(!text)return"";
  const escaped=esc(text);
  // If the entire message is a single image/gif URL, render just the image
  const singleMatch=text.trim().match(IMG_URL_RE);
  if(singleMatch){
    return'<img class="file-img-preview" src="'+esc(singleMatch[1])+'" alt="image" loading="lazy" onerror="this.style.display=\'none\'">';
  }
  // Otherwise render URLs as clickable links, and embed any image URLs below
  let html=escaped.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--acc);word-break:break-all">$1</a>');
  // Find any image URLs within the text and append inline previews
  const imgMatches=[...text.matchAll(IMG_URL_INLINE_RE)];
  if(imgMatches.length){
    for(const match of imgMatches){
      html+='<br><img class="file-img-preview" src="'+esc(match[1])+'" alt="image" loading="lazy" onerror="this.style.display=\'none\'">';
    }
  }
  return html;
}

function sendMsg(t){if(!t.trim())return;const msg={id:S.me.id+"-"+Date.now()+"-"+Math.random().toString(36).slice(2,6),userId:S.me.id,userName:S.me.name,userColor:S.me.color,userAvatar:S.me.avatar,content:t.trim(),ts:Date.now()};S.messages.push(msg);broadcast({type:"message",msg});qr();scrollBot()}
let typeTh=0;function sendTyp(){const n=Date.now();if(n-typeTh>2000){typeTh=n;broadcast({type:"typing",userId:S.me.id})}}
function doReact(mid,emoji){const msg=S.messages.find(m=>m.id===mid);if(!msg)return;if(!msg.reactions)msg.reactions={};if(!msg.reactions[emoji])msg.reactions[emoji]={count:0,users:[]};const r=msg.reactions[emoji],idx=r.users.indexOf(S.me.id);if(idx>=0){r.users.splice(idx,1);r.count--;if(r.count<=0)delete msg.reactions[emoji]}else{r.users.push(S.me.id);r.count++}broadcast({type:"reaction",msgId:mid,emoji,userId:S.me.id});qr()}
function doEdit(mid,t){const msg=S.messages.find(m=>m.id===mid);if(msg&&msg.userId===S.me.id&&t.trim()){msg.content=t.trim();msg.edited=true;broadcast({type:"edit",msgId:mid,content:msg.content});qr()}}
function doDelete(mid){const msg=S.messages.find(m=>m.id===mid);if(msg&&msg.userId===S.me.id){S.messages=S.messages.filter(m=>m.id!==mid);broadcast({type:"delete",msgId:mid});persistDeleteMsg(mid);qr()}}
function sysMsg(t){S.messages.push({id:"sys-"+Date.now()+Math.random().toString(36).slice(2,6),system:true,content:t,ts:Date.now()});qr();scrollBot()}
function copyCode(){navigator.clipboard?.writeText(S.roomCode).then(()=>{S.copyToast=true;qr();setTimeout(()=>{S.copyToast=false;qr()},2000)})}
function scrollBot(){setTimeout(()=>{const el=document.getElementById("msg-list");if(el)el.scrollTop=el.scrollHeight},30)}

// â”€â”€ Create / Join â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doCreate(name,color){
  const room=genCode(),myId="nexus-"+room+"-host";
  S.me={id:myId,name,color,avatar:name[0].toUpperCase()};S.roomCode=room;
  S.cryptoKey=await deriveRoomKey(room);
  dlog("Creating room "+room+"...");startMqtt(room);
  const peer=new Peer(myId,{debug:1,config:{iceServers:ICE_SERVERS}});S.peer=peer;
  peer.on("open",()=>{dlog("PeerJS signaling OK",true);S.connected=true;S.screen="chat";S.peerError=null;sysMsg("Room created! Share code: "+room);sysMsg("ğŸ”’ End-to-end encrypted");if(S.persist){sysMsg("ğŸ’¾ Persistent room â€” history saved locally");persistLoad(room).then(msgs=>{if(msgs.length){const have=new Set(S.messages.map(m=>m.id));const nu=msgs.filter(m=>!have.has(m.id));if(nu.length){S.messages.push(...nu);S.messages.sort((a,b)=>a.ts-b.ts);sysMsg("ğŸ’¾ Loaded "+nu.length+" saved messages");qr();scrollBot()}}})}qr()});
  peer.on("connection",c=>{dlog("Incoming WebRTC",true);setup(c,false)});
  peer.on("error",e=>{dlog("PeerJS: "+e.type,false);S.peerError=e.type==="unavailable-id"?"Code in use.":"Error: "+e.type;qr()});
  peer.on("disconnected",()=>{setTimeout(()=>{if(!peer.destroyed)peer.reconnect()},2000)});
}
async function doJoin(name,color,code){
  code=code.toUpperCase().replace(/[^A-Z0-9]/g,"");if(code.length<4)return;
  const myId="nexus-"+code+"-"+Date.now().toString(36);
  S.me={id:myId,name,color,avatar:name[0].toUpperCase()};S.roomCode=code;
  S.cryptoKey=await deriveRoomKey(code);
  dlog("Joining room "+code+"...");startMqtt(code);
  const peer=new Peer(myId,{debug:1,config:{iceServers:ICE_SERVERS}});S.peer=peer;
  let retries=0;const maxR=5;const hostId="nexus-"+code+"-host";
  function tryConn(){if(retries>=maxR){dlog("WebRTC: host not found",false);S.webrtcFailed=true;if(S.mqttReady){S.mode="relay";sysMsg("Connected via relay");qr()}return}retries++;dlog("WebRTC attempt "+retries+"/"+maxR);connectTo(hostId)}
  iceFailTimer=setTimeout(()=>{if(S.mode!=="p2p"){dlog("WebRTC timeout â€” relay",false);S.webrtcFailed=true;if(S.mqttReady){S.mode="relay";sysMsg("Connected via relay (WebSocket)");qr()}}},15000);
  peer.on("open",()=>{dlog("PeerJS signaling OK",true);S.connected=true;S.screen="chat";S.peerError=null;qr();setTimeout(tryConn,500)});
  peer.on("connection",c=>setup(c,false));
  peer.on("error",e=>{dlog("PeerJS: "+e.type,false);if(e.type==="peer-unavailable"&&S.screen==="chat"&&retries<maxR)setTimeout(tryConn,1500*retries);else if(S.screen==="connect"){S.peerError=e.type==="peer-unavailable"?"Room not found.":"Error: "+e.type;qr()}});
  peer.on("disconnected",()=>{setTimeout(()=>{if(!peer.destroyed)peer.reconnect()},2000)});
  // Load persistent history if enabled
  if(S.persist){
    persistLoad(code).then(msgs=>{
      if(msgs.length){
        const have=new Set(S.messages.map(m=>m.id));
        const nu=msgs.filter(m=>!have.has(m.id));
        if(nu.length){S.messages.push(...nu);S.messages.sort((a,b)=>a.ts-b.ts);qr();scrollBot()}
        dlog("Loaded "+msgs.length+" messages from local storage",true);
        sysMsg("ğŸ’¾ Loaded "+msgs.length+" saved messages");
      }
    });
  }
}
window.addEventListener("beforeunload",()=>{if(S.mqtt&&S.mqttReady)mqttSend({type:"leave",userId:S.me?.id,userName:S.me?.name})});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doRender(){renderQ=false;if(S.screen==="connect"&&currentScreen!=="connect"){document.getElementById("app").innerHTML=renderConnect();bindConnect();currentScreen="connect"}else if(S.screen==="chat"){if(currentScreen!=="chat"){document.getElementById("app").innerHTML=renderChat();bindChat();currentScreen="chat";scrollBot()}else{updateMsgs();updatePeers();updateTypBar();updateToast();updateMode();updateVoiceBar()}}}

function renderConnect(){
  const persistOn=localStorage.getItem("nexus-persist")==="1";
  return '<div class="connect-screen"><div class="connect-card"><h1>âš¡ NEXUS</h1><p class="sub">End-to-end encrypted chat with voice. No accounts.</p><label>YOUR NAME</label><input id="c-name" placeholder="Enter your name" maxlength="20" autofocus><label>PICK A COLOR</label><div class="color-pick">'+COLORS.map((c,i)=>'<div class="color-swatch'+(i===0?" active":"")+'" data-color="'+c+'" style="background:'+c+'"></div>').join("")+'</div><button id="c-create" class="btn-primary" disabled>Create Room</button><div class="divider-text"><div class="line"></div>or join existing<div class="line"></div></div><label>ROOM CODE</label><input id="c-room" class="mono-input" placeholder="ABC123" maxlength="6"><button id="c-join" class="btn-secondary" disabled>Join Room</button><div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--brd)"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="c-persist" '+(persistOn?"checked":"")+'><span style="font-size:12px;color:var(--txt)">ğŸ’¾ Persistent room</span></label><div style="font-size:10px;color:var(--fnt);margin-top:4px;padding-left:24px">Chat history saved in your browser. Room stays active for 10 days.</div></div>'+(S.peerError?'<div style="color:var(--red);font-size:13px;margin-top:16px;padding:8px;background:var(--bg0);border-radius:6px">'+esc(S.peerError)+'</div>':'')+'</div></div>';
}
function bindConnect(){const n=document.getElementById("c-name"),r=document.getElementById("c-room"),persist=document.getElementById("c-persist"),cb=document.getElementById("c-create"),jb=document.getElementById("c-join");let color=COLORS[0];
  function getPersist(){const on=persist?.checked||false;try{localStorage.setItem("nexus-persist",on?"1":"0")}catch(e){}return on}
  function upd(){cb.disabled=!n.value.trim();jb.disabled=!n.value.trim()||r.value.length<4}n.addEventListener("input",upd);r.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");upd()});document.querySelectorAll(".color-swatch").forEach(el=>el.addEventListener("click",()=>{document.querySelectorAll(".color-swatch").forEach(s=>s.classList.remove("active"));el.classList.add("active");color=el.dataset.color}));cb.addEventListener("click",()=>{if(n.value.trim()){S.persist=getPersist();doCreate(n.value.trim(),color)}});jb.addEventListener("click",()=>{if(n.value.trim()&&r.value.length>=4){S.persist=getPersist();doJoin(n.value.trim(),color,r.value)}});n.addEventListener("keydown",e=>{if(e.key==="Enter"&&!cb.disabled)cb.click()});r.addEventListener("keydown",e=>{if(e.key==="Enter"&&!jb.disabled)jb.click()})}

function renderChat(){
  const voiceHtml='<div class="voice-bar" id="voice-bar">'+(S.voice.joined?
    '<button class="ptt-btn'+(S.voice.transmitting?" active":"")+'" id="ptt-btn" title="Hold to talk">ğŸ¤</button><div class="voice-info"><div class="voice-status'+(S.voice.transmitting?" tx":"")+'">'+
    (S.voice.transmitting?"ğŸ”´ Transmitting...":"Hold ğŸ¤ or Space to talk")+
    '</div><div class="voice-viz" id="voice-viz">'+S.voice.vizBars.map(h=>'<div class="bar" style="height:'+h+'px"></div>').join("")+'</div>'+
    (S.voice.speakers.size?'<div style="margin-top:2px">'+[...S.voice.speakers.values()].map(s=>'<span class="speaker-icon">ğŸ”Š '+esc(s.name)+'</span>').join(" ")+'</div>':"")+
    '</div><button id="voice-leave" style="background:none;border:1px solid var(--brd);color:var(--red);cursor:pointer;padding:4px 10px;border-radius:6px;font-size:11px;font-family:var(--mono)">Leave</button>':
    '<button id="voice-join" style="background:none;border:1px solid var(--brd);color:var(--acc);cursor:pointer;padding:8px 16px;border-radius:8px;font-size:13px;font-family:var(--mono);display:flex;align-items:center;gap:6px;margin:0 auto"><span style="font-size:16px">ğŸ™ï¸</span> Join Voice</button>')+
    '</div>';

  return '<div class="sidebar" id="sidebar"><div class="sb-header"><span style="font-size:20px">âš¡</span><h2>NEXUS P2P</h2></div><div style="padding:12px 16px"><div class="room-code-box" id="copy-code" title="Click to copy"><div style="flex:1"><div style="font-size:10px;color:var(--mut);font-weight:600;letter-spacing:1px">ROOM CODE</div><div style="font-family:var(--mono);font-size:16px;color:var(--acc);font-weight:700;letter-spacing:2px">'+S.roomCode+'</div></div><span style="font-size:16px;color:var(--mut)">ğŸ“‹</span></div><div style="font-size:11px;color:var(--fnt);text-align:center;margin-top:4px">Share this code to invite others</div></div><div style="padding:0 16px 8px"><div style="height:1px;background:var(--brd)"></div></div><div style="padding:4px 16px 8px;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--fnt)" id="sb-count">PEERS â€” 1</div><div style="flex:1;overflow-y:auto;padding:0 8px" id="sb-peers"></div>'+voiceHtml+'<div class="user-panel"><div class="peer-av" style="background:linear-gradient(135deg,'+S.me.color+'30,'+S.me.color+'10);border:2px solid '+S.me.color+'55;color:'+S.me.color+';width:32px;height:32px;min-width:32px;font-size:12px"><div class="st-dot" style="background:var(--grn)"></div>'+esc(S.me.avatar)+'</div><div style="flex:1"><div style="font-family:var(--mono);font-size:12px;font-weight:700;color:'+S.me.color+'">'+esc(S.me.name)+'</div><div style="font-size:10px;color:var(--fnt)" id="user-mode">Connecting...</div></div></div></div><div class="chat-area"><div class="chat-header"><button class="menu-btn" id="menu-btn" style="background:none;border:none;color:var(--mut);cursor:pointer;padding:4px;display:none">â˜°</button><span id="mode-badge" class="relay-badge relay">RELAY</span><h3>Room Chat</h3><span style="font-size:11px;color:var(--grn);font-family:var(--mono);margin-left:8px" title="End-to-end encrypted">ğŸ”’ E2E</span><span style="color:var(--fnt);font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:12px" id="hdr-info">connecting...</span><button id="tog-mem" style="background:none;border:none;color:var(--txt);cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></button><button id="tog-diag" style="background:none;border:none;color:var(--fnt);cursor:pointer;padding:6px;border-radius:6px;font-size:14px;font-family:var(--mono)" title="Diagnostics">ğŸ”§</button></div><div class="msg-list" id="msg-list"></div><div class="typing-bar" id="typ-bar"></div><div id="mobile-voice" style="display:none"></div><div class="input-area"><div class="input-row"><input type="file" id="file-in" style="display:none" multiple><input type="file" id="gif-in" style="display:none" accept="image/gif,.gif"><button id="attach-btn" title="Attach file" style="padding:10px;cursor:pointer;border-radius:4px;background:none;border:none;color:var(--acc);font-size:14px;display:flex;align-items:center;flex-shrink:0;min-width:36px;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button><button id="gif-btn" title="Send GIF" style="padding:6px 8px;cursor:pointer;border-radius:4px;background:none;border:1px solid var(--brd);color:var(--mut);font-size:12px;font-family:var(--mono);font-weight:800;display:flex;align-items:center;flex-shrink:0;letter-spacing:1px;line-height:1">GIF</button><input id="msg-in" placeholder="Send a messageâ€¦" autocomplete="off"><button id="mobile-mic-btn" title="Voice chat" style="padding:10px;cursor:pointer;border-radius:4px;background:none;border:none;color:var(--mut);font-size:14px;display:none;align-items:center;flex-shrink:0;min-width:36px;justify-content:center"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button><button class="send-btn" id="send-btn" title="Send"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div></div></div><div class="members-panel" id="mem-panel"><div id="mem-hdr" class="mem-header">ONLINE â€” 1</div><div id="mem-list"></div></div><div id="diag-panel" style="display:none;position:fixed;bottom:0;right:0;width:420px;max-width:90vw;max-height:50vh;background:var(--bg0);border:1px solid var(--brdL);border-radius:12px 0 0 0;z-index:100;overflow:hidden;box-shadow:0 -4px 24px rgba(0,0,0,.5)"><div style="padding:10px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px"><span style="font-size:14px">ğŸ”§</span><span style="font-size:12px;font-weight:700;color:var(--acc);font-family:var(--mono);flex:1">DIAGNOSTICS</span><button id="diag-close" style="background:none;border:none;color:var(--mut);cursor:pointer;font-size:16px">âœ•</button></div><div id="diag-log" style="padding:8px 12px;overflow-y:auto;max-height:calc(50vh - 40px);font-family:var(--mono);font-size:11px;line-height:1.8"></div></div>'}

function bindChat(){
  const inp=document.getElementById("msg-in");inp?.focus();
  inp?.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMsg(inp.value);inp.value=""}else sendTyp()});
  document.getElementById("send-btn")?.addEventListener("click",()=>{if(inp?.value){sendMsg(inp.value);inp.value="";inp.focus()}});
  document.getElementById("copy-code")?.addEventListener("click",copyCode);
  document.getElementById("tog-mem")?.addEventListener("click",()=>{S.showMembers=!S.showMembers;const p=document.getElementById("mem-panel");if(p)p.style.display=S.showMembers?"":"none"});
  document.getElementById("menu-btn")?.addEventListener("click",()=>{S.mobileSidebar=!S.mobileSidebar;document.getElementById("sidebar")?.classList.toggle("open",S.mobileSidebar)});
  document.getElementById("tog-diag")?.addEventListener("click",()=>{const p=document.getElementById("diag-panel");if(p){p.style.display=p.style.display==="none"?"block":"none";if(p.style.display==="block"){const el=document.getElementById("diag-log");if(el){el.innerHTML=S.diag.map(d=>'<div style="color:'+(d.ok===true?"var(--grn)":d.ok===false?"var(--red)":"var(--mut)")+'"><span style="opacity:.5">'+d.t+'</span> '+(d.ok===true?"âœ“ ":d.ok===false?"âœ— ":"â€¢ ")+esc(d.msg)+'</div>').join("");el.scrollTop=el.scrollHeight}}}});
  document.getElementById("diag-close")?.addEventListener("click",()=>{const p=document.getElementById("diag-panel");if(p)p.style.display="none"});
  document.getElementById("attach-btn")?.addEventListener("click",()=>document.getElementById("file-in")?.click());
  document.getElementById("gif-btn")?.addEventListener("click",toggleGifPanel);
  document.getElementById("file-in")?.addEventListener("change",e=>{const files=e.target.files;if(files)for(const f of files)sendFile(f);e.target.value=""});
  document.getElementById("gif-in")?.addEventListener("change",e=>{const files=e.target.files;if(files)for(const f of files)sendFile(f);e.target.value=""});
  // Drag and drop
  const chatArea=document.querySelector(".chat-area");
  if(chatArea){
    chatArea.addEventListener("dragover",e=>{e.preventDefault();e.stopPropagation();chatArea.style.outline="2px dashed var(--acc)";chatArea.style.outlineOffset="-4px"});
    chatArea.addEventListener("dragleave",e=>{e.preventDefault();chatArea.style.outline="none"});
    chatArea.addEventListener("drop",e=>{e.preventDefault();e.stopPropagation();chatArea.style.outline="none";if(e.dataTransfer?.files)for(const f of e.dataTransfer.files)sendFile(f)});
  }
  // Paste files
  document.addEventListener("paste",e=>{if(e.clipboardData?.files?.length){e.preventDefault();for(const f of e.clipboardData.files)sendFile(f)}});
  if(window.innerWidth<=600){const m=document.getElementById("menu-btn");if(m)m.style.display="flex";const mb=document.getElementById("mobile-mic-btn");if(mb)mb.style.display="flex"}
  // Mobile mic button â€” join or show PTT
  document.getElementById("mobile-mic-btn")?.addEventListener("click",()=>{
    if(!S.voice.joined){voiceJoin();updateMobileVoice()}
    else{voiceLeave();updateMobileVoice()}
  });
  bindVoice();
  updateMsgs();updatePeers();updateMode();
}

function bindVoice(){
  document.getElementById("voice-join")?.addEventListener("click",voiceJoin);
  document.getElementById("voice-leave")?.addEventListener("click",voiceLeave);
  const ptt=document.getElementById("ptt-btn");
  if(ptt){
    ptt.addEventListener("mousedown",e=>{e.preventDefault();voiceStartTx()});
    ptt.addEventListener("mouseup",voiceStopTx);
    ptt.addEventListener("mouseleave",voiceStopTx);
    ptt.addEventListener("touchstart",e=>{e.preventDefault();voiceStartTx()},{passive:false});
    ptt.addEventListener("touchend",voiceStopTx);
    ptt.addEventListener("touchcancel",voiceStopTx);
  }
}

// â”€â”€ Smart Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastHash="";
function mHash(){return S.messages.length+"|"+S.messages.slice(-5).map(m=>m.id+(m.edited?"e":"")+JSON.stringify(m.reactions||{})).join(",")}
function updateMsgs(){
  const el=document.getElementById("msg-list");if(!el)return;
  const h=mHash();if(h===lastHash)return;lastHash=h;
  const near=el.scrollHeight-el.scrollTop-el.clientHeight<120;
  let html='<div style="padding:32px 16px 16px"><div style="width:56px;height:56px;border-radius:28px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:12px">ğŸ”’</div><h2 style="font-size:22px;font-weight:800;color:#fff;margin:0 0 4px">Peer-to-Peer Room</h2><p style="color:var(--mut);font-size:13px">End-to-end encrypted. No data stored.</p></div>';
  let ld="",lu="",lt=0;
  for(const m of S.messages){
    const date=fmtDate(m.ts);
    if(date!==ld){html+='<div class="date-divider"><div class="line"></div><span>'+date+'</span><div class="line"></div></div>';ld=date;lu=""}
    if(m.system){html+='<div class="message system"><span style="color:var(--fnt);font-size:12px;font-style:italic">'+esc(m.content)+'</span></div>';lu="";continue}
    const compact=m.userId===lu&&(m.ts-lt)<300000;const own=m.userId===S.me.id;
    let rh="";if(m.reactions&&Object.keys(m.reactions).length){rh='<div class="reactions">';for(const[em,rd]of Object.entries(m.reactions)){rh+='<button class="reaction'+(rd.users.includes(S.me.id)?" mine":"")+'" onclick="doReact(\''+m.id+"','"+em+"'\")>"+em+"<span>"+rd.count+"</span></button>"}rh+="</div>"}
    const acts='<div class="msg-actions"><button class="act-btn" onclick="showEmoji(this,\''+m.id+'\')" title="React">ğŸ˜Š</button>'+(own?'<button class="act-btn" onclick="startEdit(\''+m.id+'\')" title="Edit">âœï¸</button><button class="act-btn" onclick="doDelete(\''+m.id+'\')" title="Delete">ğŸ—‘ï¸</button>':"")+"</div>";
    const fh=m.file?renderFileMsg(m):"";
    const bodyContent=m.file?(m.content?esc(m.content):""):renderContent(m.content);
    if(compact){html+='<div class="message compact" data-mid="'+m.id+'">'+acts+(bodyContent?'<div class="msg-body" id="b-'+m.id+'">'+bodyContent+(m.edited?' <span style="font-size:10px;color:var(--fnt)">(edited)</span>':"")+"</div>":"")+fh+rh+"</div>"}
    else{html+='<div class="message msg-enter" data-mid="'+m.id+'">'+acts+'<div class="peer-av" style="background:linear-gradient(135deg,'+m.userColor+'30,'+m.userColor+'10);border:2px solid '+m.userColor+'55;color:'+m.userColor+';width:38px;height:38px;min-width:38px;font-size:14px">'+esc(m.userAvatar)+'</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:baseline;gap:8px;margin-bottom:2px"><span class="msg-author" style="color:'+m.userColor+'">'+esc(m.userName)+'</span><span class="msg-time">'+fmtTime(m.ts)+"</span>"+(m.edited?'<span style="font-size:10px;color:var(--fnt)">(edited)</span>':"")+"</div>"+(bodyContent?'<div class="msg-body" id="b-'+m.id+'">'+bodyContent+"</div>":"")+fh+rh+"</div></div>"}
    lu=m.userId;lt=m.ts;
  }
  el.innerHTML=html;if(near)el.scrollTop=el.scrollHeight;
}
function updatePeers(){
  const peers=getPeers();const all=[S.me,...peers.map(p=>({name:p.name,color:p.color,avatar:p.avatar,id:p.id}))];const n=all.length;
  const c=document.getElementById("sb-count");if(c)c.textContent="PEERS â€” "+n;
  const sl=document.getElementById("sb-peers");if(sl)sl.innerHTML=all.map((u,i)=>'<div class="peer-item"><div class="peer-av" style="background:linear-gradient(135deg,'+u.color+'30,'+u.color+'10);border:2px solid '+u.color+'55;color:'+u.color+'"><div class="st-dot" style="background:var(--grn)"></div>'+esc(u.avatar)+'</div><div><div style="font-weight:600;font-size:13px;color:'+u.color+'">'+esc(u.name)+(i===0?' <span style="color:var(--fnt);font-weight:400">(you)</span>':"")+"</div></div></div>").join("");
  const hi=document.getElementById("hdr-info");if(hi)hi.textContent=n+" peer"+(n!==1?"s":"")+" â€¢ "+(S.mode==="p2p"?"direct P2P":S.mode==="relay"?"relayed":"connecting...");
  const mh=document.getElementById("mem-hdr");if(mh)mh.textContent="ONLINE â€” "+n;
  const ml=document.getElementById("mem-list");if(ml)ml.innerHTML=all.map((u,i)=>'<div class="peer-item"><div class="peer-av" style="background:linear-gradient(135deg,'+u.color+'30,'+u.color+'10);border:2px solid '+u.color+'55;color:'+u.color+';width:30px;height:30px;min-width:30px;font-size:12px"><div class="st-dot" style="background:var(--grn)"></div>'+esc(u.avatar)+'</div><span style="font-weight:500;font-size:13px;color:'+u.color+'">'+esc(u.name)+(i===0?' <span style="color:var(--fnt);font-weight:400">(you)</span>':"")+"</span></div>").join("");
}
function updateTypBar(){const bar=document.getElementById("typ-bar");if(!bar)return;const names=[];S.typing.forEach((_,uid)=>{const u=S.knownUsers.get(uid);if(u)names.push(u.name)});bar.innerHTML=names.length?'<span class="dot">â—</span><span class="dot" style="animation-delay:.15s">â—</span><span class="dot" style="animation-delay:.3s">â—</span> <strong>'+esc(names.join(", "))+'</strong> '+(names.length===1?"is":"are")+' typingâ€¦':"";}
function updateToast(){const ex=document.querySelector(".copy-toast");if(S.copyToast&&!ex){const t=document.createElement("div");t.className="copy-toast";t.textContent="Room code copied!";document.body.appendChild(t)}else if(!S.copyToast&&ex)ex.remove()}
function updateMode(){
  const badge=document.getElementById("mode-badge");const um=document.getElementById("user-mode");
  if(badge){
    if(S.mode==="p2p"){badge.className="relay-badge p2p";badge.textContent="âš¡ P2P"}
    else if(S.mode==="relay"){badge.className="relay-badge relay";badge.textContent="ğŸ“¡ RELAY"}
    else{badge.className="relay-badge relay";badge.textContent="â³ ...";badge.style.opacity=".5"}
  }
  if(um)um.textContent=(S.mode==="p2p"?"Direct P2P":S.mode==="relay"?"Relay mode":"Connecting...")+(S.persist?" â€¢ ğŸ’¾":"");
}
function updateVoiceBar(){
  const vb=document.getElementById("voice-bar");
  if(!vb)return;
  if(S.voice.joined){
    const statusEl=vb.querySelector(".voice-status");
    if(statusEl){
      statusEl.className="voice-status"+(S.voice.transmitting?" tx":"");
      statusEl.innerHTML=S.voice.transmitting?"ğŸ”´ Transmitting...":"Hold ğŸ¤ or Space to talk";
    }
  }
  updateMobileVoice();
}

function updateMobileVoice(){
  const mv=document.getElementById("mobile-voice");
  const mb=document.getElementById("mobile-mic-btn");
  if(!mv)return;
  if(!S.voice.joined){
    mv.style.display="none";
    if(mb)mb.style.color="var(--mut)";
    return;
  }
  if(mb)mb.style.color="var(--grn)";
  mv.style.display="flex";
  mv.style.cssText="display:flex;align-items:center;gap:8px;padding:6px 16px;background:var(--bg3);border-top:1px solid var(--brd)";
  const spkHtml=S.voice.speakers.size?[...S.voice.speakers.values()].map(s=>'<span class="speaker-icon">ğŸ”Š '+esc(s.name)+'</span>').join(" "):"";
  mv.innerHTML='<button class="ptt-btn'+(S.voice.transmitting?" active":"")+'" id="mobile-ptt" style="width:40px;height:40px;font-size:16px">ğŸ¤</button><div style="flex:1;min-width:0"><div class="voice-status'+(S.voice.transmitting?" tx":"")+'">'+
    (S.voice.transmitting?"ğŸ”´ Transmitting...":"Hold to talk")+
    '</div>'+spkHtml+'</div><button id="mobile-voice-leave" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:11px;font-family:var(--mono);padding:4px 8px">âœ•</button>';
  // Bind mobile PTT
  const ptt=document.getElementById("mobile-ptt");
  if(ptt){
    ptt.addEventListener("mousedown",e=>{e.preventDefault();voiceStartTx()});
    ptt.addEventListener("mouseup",voiceStopTx);
    ptt.addEventListener("mouseleave",voiceStopTx);
    ptt.addEventListener("touchstart",e=>{e.preventDefault();voiceStartTx()},{passive:false});
    ptt.addEventListener("touchend",voiceStopTx);
    ptt.addEventListener("touchcancel",voiceStopTx);
  }
  document.getElementById("mobile-voice-leave")?.addEventListener("click",()=>{voiceLeave();updateMobileVoice()});
}

// â”€â”€ Global handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doReact=doReact;window.doDelete=doDelete;window.downloadFile=downloadFile;
window.showEmoji=function(btn,mid){document.querySelectorAll(".emoji-picker").forEach(p=>p.remove());const pk=document.createElement("div");pk.className="emoji-picker";pk.innerHTML=EMOJIS.map(e=>'<button class="emoji-opt" data-e="'+e+'">'+e+"</button>").join("");btn.closest(".msg-actions").appendChild(pk);pk.querySelectorAll(".emoji-opt").forEach(el=>el.addEventListener("click",ev=>{ev.stopPropagation();doReact(mid,el.dataset.e);pk.remove()}));setTimeout(()=>{const cl=ev=>{if(!pk.contains(ev.target)){pk.remove();document.removeEventListener("click",cl)}};document.addEventListener("click",cl)},10)};
window.startEdit=function(mid){const msg=S.messages.find(m=>m.id===mid);if(!msg)return;const el=document.getElementById("b-"+mid);if(!el)return;el.innerHTML='<input class="edit-input" value="'+esc(msg.content).replace(/"/g,"&quot;")+'" id="ed-'+mid+'"><div style="font-size:11px;color:var(--fnt);margin-top:4px">escape to cancel â€¢ enter to save</div>';const inp=document.getElementById("ed-"+mid);if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length);inp.addEventListener("keydown",e=>{if(e.key==="Enter")doEdit(mid,inp.value);if(e.key==="Escape"){lastHash="";updateMsgs()}})}};

// Keyboard: Space for PTT, Ctrl+M toggle members
document.addEventListener("keydown",e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==="m"){e.preventDefault();S.showMembers=!S.showMembers;const p=document.getElementById("mem-panel");if(p)p.style.display=S.showMembers?"":"none"}
  if(e.key==="Escape")document.querySelectorAll(".emoji-picker").forEach(p=>p.remove());
  // Space for PTT (only when not typing in input)
  if(e.code==="Space"&&S.voice.joined&&!S.voice.transmitting&&document.activeElement?.tagName!=="INPUT"&&document.activeElement?.tagName!=="TEXTAREA"){e.preventDefault();voiceStartTx()}
});
document.addEventListener("keyup",e=>{
  if(e.code==="Space"&&S.voice.transmitting){voiceStopTx()}
});

doRender();
openIDB().then(()=>{persistCleanExpired();}).catch(()=>{});
</script></body></html>
