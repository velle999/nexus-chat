<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS P2P</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg0:#06060e;--bg1:#0a0a14;--bg2:#0e0e1c;--bg3:#14142a;--bg4:#1a1a36;--brd:rgba(255,255,255,.06);--brdL:rgba(255,255,255,.1);--txt:#d0d0e8;--mut:#666688;--fnt:#444466;--acc:#00ffd5;--accD:rgba(0,255,213,.15);--red:#ff4466;--grn:#44ff88;--pink:#ff6bfa;--warn:#ffaa00;--ff:'Outfit',sans-serif;--mono:'JetBrains Mono',monospace}
html,body{height:100%;overflow:hidden;background:var(--bg1);color:var(--txt);font-family:var(--ff)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}
::selection{background:rgba(0,255,213,.2);color:#fff}
input,textarea{font-family:var(--ff)}input::placeholder{color:var(--fnt)}
input:focus,button:focus-visible{outline:2px solid rgba(0,255,213,.3);outline-offset:2px}
button:focus:not(:focus-visible){outline:none}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-4px);opacity:1}}
.msg-enter{animation:fadeIn .15s ease}
.dot{animation:typing 1s infinite;display:inline-block;font-size:8px}
#app{display:flex;height:100vh;width:100vw;overflow:hidden}
.sidebar{width:260px;min-width:260px;background:var(--bg2);display:flex;flex-direction:column;border-right:1px solid var(--brd);flex-shrink:0}
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.members-panel{width:220px;min-width:220px;background:var(--bg2);border-left:1px solid var(--brd);overflow-y:auto;flex-shrink:0}
.sb-header{padding:16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px}
.sb-header h2{font-size:16px;font-weight:800;color:#fff;font-family:var(--mono);letter-spacing:.5px}
.room-code-box{display:flex;align-items:center;gap:8px;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:10px 12px;cursor:pointer;transition:border-color .15s}
.room-code-box:hover{border-color:var(--acc)}
.copy-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--brdL);border-radius:8px;padding:8px 16px;color:var(--acc);font-size:13px;font-weight:600;z-index:999;animation:modalIn .15s ease;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.peer-av{width:34px;height:34px;min-width:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;font-size:14px;position:relative;flex-shrink:0}
.peer-av .st-dot{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2.5px solid var(--bg2)}
.peer-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;transition:background .1s}
.peer-item:hover{background:rgba(255,255,255,.04)}
.user-panel{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg0);border-top:1px solid var(--brd)}
.chat-header{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--brd);min-height:50px;gap:8px}
.chat-header h3{font-size:15px;font-weight:700;color:#fff}
.msg-list{flex:1;overflow-y:auto;padding:0 0 8px}
.message{display:flex;gap:12px;padding:6px 16px;transition:background .1s;position:relative}
.message:hover{background:rgba(255,255,255,.03)}
.message.compact{padding:1px 16px 1px 62px}
.message.system{padding:4px 16px;justify-content:center}
.msg-author{font-weight:700;font-size:14px;font-family:var(--mono)}
.msg-time{color:var(--fnt);font-size:11px;font-family:var(--mono)}
.msg-body{color:var(--txt);font-size:14px;line-height:1.55;word-break:break-word}
.reactions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.reaction{background:rgba(255,255,255,.05);border:1px solid var(--brd);border-radius:10px;padding:2px 8px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:3px;transition:all .15s}
.reaction.mine{background:var(--accD);border-color:rgba(0,255,213,.3)}
.reaction span{font-family:var(--mono);font-size:11px}
.msg-actions{position:absolute;top:-4px;right:12px;display:none;gap:1px;background:var(--bg3);border-radius:6px;border:1px solid var(--brdL);padding:2px;z-index:5;box-shadow:0 4px 12px rgba(0,0,0,.3)}
.message:hover .msg-actions{display:flex}
.act-btn{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:14px;background:none;border:none;color:var(--mut);transition:background .1s;line-height:1}
.act-btn:hover{background:rgba(255,255,255,.08)}
.emoji-picker{position:absolute;top:32px;right:0;display:flex;gap:2px;background:var(--bg3);border-radius:8px;border:1px solid var(--brdL);padding:6px;z-index:10;box-shadow:0 8px 24px rgba(0,0,0,.4);flex-wrap:wrap;width:200px}
.emoji-opt{padding:4px 6px;cursor:pointer;border-radius:4px;font-size:20px;background:none;border:none;transition:background .1s}
.emoji-opt:hover{background:rgba(255,255,255,.08)}
.date-divider{display:flex;align-items:center;gap:8px;padding:16px 16px 4px}
.date-divider span{font-size:11px;font-weight:600;color:var(--mut);font-family:var(--mono);white-space:nowrap}
.date-divider .line{flex:1;height:1px;background:var(--brd)}
.input-area{padding:0 16px 14px;flex-shrink:0}
.input-row{display:flex;align-items:center;background:var(--bg3);border-radius:8px;border:1px solid var(--brd);padding:0 6px}
.input-row input{flex:1;background:transparent;border:none;color:var(--txt);font-size:14px;padding:12px 8px;min-width:0}
.send-btn{padding:8px;cursor:pointer;border-radius:4px;background:none;border:none;color:var(--fnt);font-size:14px;transition:color .15s;display:flex;align-items:center}
.send-btn:hover{color:var(--acc)}
.typing-bar{padding:4px 12px 2px;font-size:11px;color:var(--mut);min-height:20px}
.connect-screen{display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;background:var(--bg1)}
.connect-card{background:var(--bg2);border:1px solid var(--brdL);border-radius:16px;padding:40px;width:440px;max-width:90vw;text-align:center;animation:modalIn .3s ease;box-shadow:0 16px 48px rgba(0,0,0,.5)}
.connect-card h1{font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.connect-card .sub{color:var(--mut);font-size:14px;margin-bottom:32px}
.connect-card label{display:block;text-align:left;font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--mut);margin-bottom:8px}
.connect-card input{width:100%;background:var(--bg0);border:1px solid var(--brdL);border-radius:8px;padding:12px 14px;color:var(--txt);font-size:14px;margin-bottom:16px}
.mono-input{font-family:var(--mono)!important;letter-spacing:2px;text-align:center;font-size:18px!important}
.btn-primary{width:100%;padding:12px 20px;border-radius:8px;background:var(--acc);color:var(--bg0);font-weight:700;font-size:15px;cursor:pointer;border:none;font-family:var(--ff);transition:opacity .15s;margin-bottom:10px}
.btn-primary:hover{opacity:.9}.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{width:100%;padding:12px 20px;border-radius:8px;background:transparent;color:var(--txt);font-weight:600;font-size:14px;cursor:pointer;border:1px solid var(--brd);font-family:var(--ff);transition:background .15s}
.btn-secondary:hover{background:rgba(255,255,255,.04)}.btn-secondary:disabled{opacity:.4;cursor:not-allowed}
.divider-text{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--fnt);font-size:12px;font-weight:600}
.divider-text .line{flex:1;height:1px;background:var(--brd)}
.color-pick{display:flex;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:14px;cursor:pointer;border:3px solid transparent;transition:border-color .15s,opacity .15s;opacity:.6}
.color-swatch.active{border-color:#fff;opacity:1}
.edit-input{width:100%;background:var(--bg3);border:1px solid var(--brdL);border-radius:6px;padding:6px 10px;color:var(--txt);font-size:14px;font-family:var(--ff)}
.mem-header{padding:14px 14px 6px;font-weight:700;font-size:11px;letter-spacing:1.5px;color:var(--mut)}
@media(max-width:900px){.members-panel{display:none}}
@media(max-width:600px){.sidebar{position:fixed;left:0;top:0;bottom:0;z-index:50;transform:translateX(-100%);transition:transform .2s}.sidebar.open{transform:translateX(0)}.mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40}.menu-btn{display:flex!important}}
</style>
</head>
<body>
<div id="app"></div>
<script>
const COLORS=["#00ffd5","#ff6bfa","#ffd000","#ff4466","#44ffaa","#6b9fff","#ff9944","#aa66ff"];
const EMOJIS=["üëç","üî•","üíú","üòÇ","üöÄ","üëÄ","‚ù§Ô∏è","üéâ"];
const RC="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
function genCode(){let c="";for(let i=0;i<6;i++)c+=RC[Math.floor(Math.random()*RC.length)];return c}
function fmtTime(ts){return new Date(ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
function fmtDate(ts){const d=new Date(ts),n=new Date();if(n-d<86400000&&d.getDate()===n.getDate())return"Today";if(n-d<172800000)return"Yesterday";return d.toLocaleDateString([],{month:"short",day:"numeric"})}
function esc(s){if(!s)return"";const d=document.createElement("div");d.textContent=s;return d.innerHTML}

const S={screen:"connect",me:null,roomCode:"",peer:null,conns:new Map(),knownUsers:new Map(),messages:[],typing:new Map(),connected:false,showMembers:true,mobileSidebar:false,copyToast:false,peerError:null};
let renderQ=false,currentScreen=null;
function qr(){if(!renderQ){renderQ=true;requestAnimationFrame(doRender)}}

function safeSend(c,d){try{if(c?.open){c.send(d);return true}}catch(e){console.warn("send fail",e)}return false}
function broadcast(d){S.conns.forEach(({conn})=>safeSend(conn,d))}
function getPeers(){const r=[];S.conns.forEach(({user},id)=>{if(user)r.push({...user,peerId:id})});return r}

function setup(conn,isInit){
  const pid=conn.peer;
  console.log("[NEXUS] setup connection to",pid,"initiator:",isInit);
  if(S.conns.has(pid)){const ex=S.conns.get(pid);if(ex.conn?.open){console.log("[NEXUS] already connected to",pid);conn.close();return}S.conns.delete(pid)}
  const e={conn,user:null,ready:false,helloed:false};S.conns.set(pid,e);
  conn.on("open",()=>{console.log("[NEXUS] conn open with",pid);e.ready=true;if(isInit){safeSend(conn,{type:"hello",user:S.me});e.helloed=true}qr()});
  conn.on("data",raw=>{let d;try{d=typeof raw==="string"?JSON.parse(raw):(raw&&typeof raw==="object"?raw:JSON.parse(String(raw)))}catch(e){console.warn("[NEXUS] parse fail",e,typeof raw,raw);return}console.log("[NEXUS] recv from",pid,d.type);onMsg(pid,d)});
  conn.on("close",()=>{console.log("[NEXUS] conn closed",pid);const u=S.conns.get(pid)?.user;S.conns.delete(pid);S.knownUsers.delete(pid);if(S.typing.has(pid)){clearTimeout(S.typing.get(pid));S.typing.delete(pid)}if(u)sysMsg(u.name+" left");qr()});
  conn.on("error",err=>{console.warn("[NEXUS] conn error",pid,err);S.conns.delete(pid);S.knownUsers.delete(pid);qr()});
}
function connectTo(pid){if(S.conns.has(pid)||pid===S.peer?.id)return;const c=S.peer.connect(pid,{reliable:true});setup(c,true)}

function onMsg(from,data){switch(data.type){
  case"hello":{const e=S.conns.get(from);if(!e)break;e.user=data.user;S.knownUsers.set(from,data.user);
    if(!e.helloed){safeSend(e.conn,{type:"hello",user:S.me});e.helloed=true;if(S.messages.length)safeSend(e.conn,{type:"sync",messages:S.messages.filter(m=>!m.system)})}
    setTimeout(()=>{const ids=[...S.conns.keys()].filter(id=>id!==from);if(ids.length)safeSend(e.conn,{type:"peers",ids})},800);
    sysMsg(data.user.name+" connected");qr();break}
  case"sync":{const have=new Set(S.messages.map(m=>m.id));const nu=(data.messages||[]).filter(m=>!have.has(m.id));if(nu.length){S.messages.push(...nu);S.messages.sort((a,b)=>a.ts-b.ts);qr();scrollBot()}break}
  case"message":{if(!S.messages.find(m=>m.id===data.msg.id)){S.messages.push(data.msg);if(S.typing.has(from)){clearTimeout(S.typing.get(from));S.typing.delete(from)}qr();scrollBot()}break}
  case"typing":{if(S.typing.has(from))clearTimeout(S.typing.get(from));S.typing.set(from,setTimeout(()=>{S.typing.delete(from);qr()},3000));qr();break}
  case"reaction":{const msg=S.messages.find(m=>m.id===data.msgId);if(!msg)break;if(!msg.reactions)msg.reactions={};if(!msg.reactions[data.emoji])msg.reactions[data.emoji]={count:0,users:[]};const r=msg.reactions[data.emoji],idx=r.users.indexOf(data.userId);if(idx>=0){r.users.splice(idx,1);r.count--;if(r.count<=0)delete msg.reactions[data.emoji]}else{r.users.push(data.userId);r.count++}qr();break}
  case"edit":{const msg=S.messages.find(m=>m.id===data.msgId);if(msg){msg.content=data.content;msg.edited=true;qr()}break}
  case"delete":{S.messages=S.messages.filter(m=>m.id!==data.msgId);qr();break}
  case"peers":{(data.ids||[]).forEach(id=>{if(id!==S.peer?.id&&!S.conns.has(id))setTimeout(()=>connectTo(id),200+Math.random()*500)});break}
}}

function sendMsg(t){if(!t.trim())return;const msg={id:S.me.id+"-"+Date.now()+"-"+Math.random().toString(36).slice(2,6),userId:S.me.id,userName:S.me.name,userColor:S.me.color,userAvatar:S.me.avatar,content:t.trim(),ts:Date.now()};S.messages.push(msg);broadcast({type:"message",msg});qr();scrollBot()}
let typeTh=0;function sendTyp(){const n=Date.now();if(n-typeTh>2000){typeTh=n;broadcast({type:"typing"})}}
function doReact(mid,emoji){const msg=S.messages.find(m=>m.id===mid);if(!msg)return;if(!msg.reactions)msg.reactions={};if(!msg.reactions[emoji])msg.reactions[emoji]={count:0,users:[]};const r=msg.reactions[emoji],idx=r.users.indexOf(S.me.id);if(idx>=0){r.users.splice(idx,1);r.count--;if(r.count<=0)delete msg.reactions[emoji]}else{r.users.push(S.me.id);r.count++}broadcast({type:"reaction",msgId:mid,emoji,userId:S.me.id});qr()}
function doEdit(mid,t){const msg=S.messages.find(m=>m.id===mid);if(msg&&msg.userId===S.me.id&&t.trim()){msg.content=t.trim();msg.edited=true;broadcast({type:"edit",msgId:mid,content:msg.content});qr()}}
function doDelete(mid){const msg=S.messages.find(m=>m.id===mid);if(msg&&msg.userId===S.me.id){S.messages=S.messages.filter(m=>m.id!==mid);broadcast({type:"delete",msgId:mid});qr()}}
function sysMsg(t){S.messages.push({id:"sys-"+Date.now()+Math.random().toString(36).slice(2,6),system:true,content:t,ts:Date.now()});qr();scrollBot()}
function copyCode(){navigator.clipboard?.writeText(S.roomCode).then(()=>{S.copyToast=true;qr();setTimeout(()=>{S.copyToast=false;qr()},2000)})}
function scrollBot(){setTimeout(()=>{const el=document.getElementById("msg-list");if(el)el.scrollTop=el.scrollHeight},30)}

function doCreate(name,color){const room=genCode(),myId="nexus-"+room+"-host";S.me={id:myId,name,color,avatar:name[0].toUpperCase()};S.roomCode=room;const peer=new Peer(myId,{debug:0});S.peer=peer;peer.on("open",()=>{S.connected=true;S.screen="chat";S.peerError=null;sysMsg("Room created! Share code: "+room);qr()});peer.on("connection",c=>setup(c,false));peer.on("error",e=>{S.peerError=e.type==="unavailable-id"?"Code in use.":"Error: "+e.type;qr()});peer.on("disconnected",()=>{setTimeout(()=>{if(!peer.destroyed)peer.reconnect()},2000)})}
function doJoin(name,color,code){code=code.toUpperCase().replace(/[^A-Z0-9]/g,"");if(code.length<4)return;const myId="nexus-"+code+"-"+Date.now().toString(36);S.me={id:myId,name,color,avatar:name[0].toUpperCase()};S.roomCode=code;const peer=new Peer(myId,{debug:0});S.peer=peer;let retries=0;const maxRetries=5;const hostId="nexus-"+code+"-host";function tryConnect(){if(retries>=maxRetries){sysMsg("Could not find room host after "+maxRetries+" attempts. Check the code and try again.");return}retries++;console.log("Connecting to host, attempt "+retries);connectTo(hostId)}peer.on("open",()=>{S.connected=true;S.screen="chat";S.peerError=null;qr();setTimeout(tryConnect,300)});peer.on("connection",c=>setup(c,false));peer.on("error",e=>{console.warn("Peer error:",e.type,e);if(e.type==="peer-unavailable"&&S.screen==="chat"&&retries<maxRetries){const delay=1000*retries;sysMsg("Connecting to room... (attempt "+(retries+1)+")");setTimeout(tryConnect,delay)}else if(S.screen==="connect"){S.peerError=e.type==="peer-unavailable"?"Room not found. Check the code.":"Error: "+e.type;qr()}});peer.on("disconnected",()=>{setTimeout(()=>{if(!peer.destroyed)peer.reconnect()},2000)})}

function doRender(){renderQ=false;if(S.screen==="connect"&&currentScreen!=="connect"){document.getElementById("app").innerHTML=renderConnect();bindConnect();currentScreen="connect"}else if(S.screen==="chat"){if(currentScreen!=="chat"){document.getElementById("app").innerHTML=renderChat();bindChat();currentScreen="chat";scrollBot()}else{updateMsgs();updatePeers();updateTypBar();updateToast()}}}

function renderConnect(){return '<div class="connect-screen"><div class="connect-card"><h1>‚ö° NEXUS</h1><p class="sub">Peer-to-peer chat. No servers. No accounts. Just vibes.</p><label>YOUR NAME</label><input id="c-name" placeholder="Enter your name" maxlength="20" autofocus><label>PICK A COLOR</label><div class="color-pick">'+COLORS.map((c,i)=>'<div class="color-swatch'+(i===0?" active":"")+'" data-color="'+c+'" style="background:'+c+'"></div>').join("")+'</div><button id="c-create" class="btn-primary" disabled>Create Room</button><div class="divider-text"><div class="line"></div>or join existing<div class="line"></div></div><label>ROOM CODE</label><input id="c-room" class="mono-input" placeholder="ABC123" maxlength="6"><button id="c-join" class="btn-secondary" disabled>Join Room</button>'+(S.peerError?'<div style="color:var(--red);font-size:13px;margin-top:16px;padding:8px;background:var(--bg0);border-radius:6px">'+esc(S.peerError)+'</div>':'')+'</div></div>'}
function bindConnect(){const n=document.getElementById("c-name"),r=document.getElementById("c-room"),cb=document.getElementById("c-create"),jb=document.getElementById("c-join");let color=COLORS[0];function upd(){cb.disabled=!n.value.trim();jb.disabled=!n.value.trim()||r.value.length<4}n.addEventListener("input",upd);r.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"");upd()});document.querySelectorAll(".color-swatch").forEach(el=>el.addEventListener("click",()=>{document.querySelectorAll(".color-swatch").forEach(s=>s.classList.remove("active"));el.classList.add("active");color=el.dataset.color}));cb.addEventListener("click",()=>{if(n.value.trim())doCreate(n.value.trim(),color)});jb.addEventListener("click",()=>{if(n.value.trim()&&r.value.length>=4)doJoin(n.value.trim(),color,r.value)});n.addEventListener("keydown",e=>{if(e.key==="Enter"&&!cb.disabled)cb.click()});r.addEventListener("keydown",e=>{if(e.key==="Enter"&&!jb.disabled)jb.click()})}

function renderChat(){return '<div class="sidebar" id="sidebar"><div class="sb-header"><span style="font-size:20px">‚ö°</span><h2>NEXUS P2P</h2></div><div style="padding:12px 16px"><div class="room-code-box" id="copy-code" title="Click to copy"><div style="flex:1"><div style="font-size:10px;color:var(--mut);font-weight:600;letter-spacing:1px">ROOM CODE</div><div style="font-family:var(--mono);font-size:16px;color:var(--acc);font-weight:700;letter-spacing:2px">'+S.roomCode+'</div></div><span style="font-size:16px;color:var(--mut)">üìã</span></div><div style="font-size:11px;color:var(--fnt);text-align:center;margin-top:4px">Share this code to invite others</div></div><div style="padding:0 16px 8px"><div style="height:1px;background:var(--brd)"></div></div><div style="padding:4px 16px 8px;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--fnt)" id="sb-count">PEERS ‚Äî 1</div><div style="flex:1;overflow-y:auto;padding:0 8px" id="sb-peers"></div><div class="user-panel"><div class="peer-av" style="background:linear-gradient(135deg,'+S.me.color+'30,'+S.me.color+'10);border:2px solid '+S.me.color+'55;color:'+S.me.color+';width:32px;height:32px;min-width:32px;font-size:12px"><div class="st-dot" style="background:var(--grn)"></div>'+esc(S.me.avatar)+'</div><div style="flex:1"><div style="font-family:var(--mono);font-size:12px;font-weight:700;color:'+S.me.color+'">'+esc(S.me.name)+'</div><div style="font-size:10px;color:var(--fnt)">Connected ‚Ä¢ P2P</div></div></div></div><div class="chat-area"><div class="chat-header"><button class="menu-btn" id="menu-btn" style="background:none;border:none;color:var(--mut);cursor:pointer;padding:4px;display:none">‚ò∞</button><span style="color:var(--mut);font-size:16px">üîí</span><h3>Room Chat</h3><span style="color:var(--fnt);font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:12px" id="hdr-info">end-to-end encrypted</span><button id="tog-mem" style="background:none;border:none;color:var(--txt);cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></button></div><div class="msg-list" id="msg-list"></div><div class="typing-bar" id="typ-bar"></div><div class="input-area"><div class="input-row"><input id="msg-in" placeholder="Send a message‚Ä¶" autocomplete="off"><button class="send-btn" id="send-btn" title="Send"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div></div></div><div class="members-panel" id="mem-panel"><div id="mem-hdr" class="mem-header">ONLINE ‚Äî 1</div><div id="mem-list"></div></div>'}
function bindChat(){const inp=document.getElementById("msg-in");inp?.focus();inp?.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMsg(inp.value);inp.value=""}else sendTyp()});document.getElementById("send-btn")?.addEventListener("click",()=>{if(inp?.value){sendMsg(inp.value);inp.value="";inp.focus()}});document.getElementById("copy-code")?.addEventListener("click",copyCode);document.getElementById("tog-mem")?.addEventListener("click",()=>{S.showMembers=!S.showMembers;const p=document.getElementById("mem-panel");if(p)p.style.display=S.showMembers?"":"none"});document.getElementById("menu-btn")?.addEventListener("click",()=>{S.mobileSidebar=!S.mobileSidebar;document.getElementById("sidebar")?.classList.toggle("open",S.mobileSidebar)});if(window.innerWidth<=600){const m=document.getElementById("menu-btn");if(m)m.style.display="flex"}updateMsgs();updatePeers()}

let lastHash = "";
function mHash() { return S.messages.length + "|" + S.messages.slice(-5).map(m => m.id + (m.edited?"e":"") + JSON.stringify(m.reactions||{})).join(","); }

function updateMsgs() {
  const el = document.getElementById("msg-list"); if (!el) return;
  const h = mHash(); if (h === lastHash) return; lastHash = h;
  const near = el.scrollHeight - el.scrollTop - el.clientHeight < 120;
  let html = '<div style="padding:32px 16px 16px"><div style="width:56px;height:56px;border-radius:28px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:12px">üîí</div><h2 style="font-size:22px;font-weight:800;color:#fff;margin:0 0 4px">Peer-to-Peer Room</h2><p style="color:var(--mut);font-size:13px">Messages travel directly between peers. No servers, no storage.</p></div>';
  let ld = "", lu = "", lt = 0;
  for (const m of S.messages) {
    const date = fmtDate(m.ts);
    if (date !== ld) { html += '<div class="date-divider"><div class="line"></div><span>' + date + '</span><div class="line"></div></div>'; ld = date; lu = ""; }
    if (m.system) { html += '<div class="message system"><span style="color:var(--fnt);font-size:12px;font-style:italic">' + esc(m.content) + '</span></div>'; lu = ""; continue; }
    const compact = m.userId === lu && (m.ts - lt) < 300000;
    const own = m.userId === S.me.id;
    let rh = "";
    if (m.reactions && Object.keys(m.reactions).length) {
      rh = '<div class="reactions">';
      for (const [em, rd] of Object.entries(m.reactions)) {
        rh += '<button class="reaction' + (rd.users.includes(S.me.id) ? " mine" : "") + '" onclick="doReact(\'' + m.id + "','" + em + '\')">' + em + '<span>' + rd.count + '</span></button>';
      }
      rh += '</div>';
    }
    const acts = '<div class="msg-actions"><button class="act-btn" onclick="showEmoji(this,\'' + m.id + '\')" title="React">üòä</button>' + (own ? '<button class="act-btn" onclick="startEdit(\'' + m.id + '\')" title="Edit">‚úèÔ∏è</button><button class="act-btn" onclick="doDelete(\'' + m.id + '\')" title="Delete">üóëÔ∏è</button>' : '') + '</div>';
    if (compact) {
      html += '<div class="message compact" data-mid="' + m.id + '">' + acts + '<div class="msg-body" id="b-' + m.id + '">' + esc(m.content) + (m.edited ? ' <span class="msg-edited" style="font-size:10px;color:var(--fnt)">(edited)</span>' : '') + '</div>' + rh + '</div>';
    } else {
      html += '<div class="message msg-enter" data-mid="' + m.id + '">' + acts + '<div class="peer-av" style="background:linear-gradient(135deg,' + m.userColor + '30,' + m.userColor + '10);border:2px solid ' + m.userColor + '55;color:' + m.userColor + ';width:38px;height:38px;min-width:38px;font-size:14px">' + esc(m.userAvatar) + '</div><div style="flex:1;min-width:0"><div style="display:flex;align-items:baseline;gap:8px;margin-bottom:2px"><span class="msg-author" style="color:' + m.userColor + '">' + esc(m.userName) + '</span><span class="msg-time">' + fmtTime(m.ts) + '</span>' + (m.edited ? '<span style="font-size:10px;color:var(--fnt)">(edited)</span>' : '') + '</div><div class="msg-body" id="b-' + m.id + '">' + esc(m.content) + '</div>' + rh + '</div></div>';
    }
    lu = m.userId; lt = m.ts;
  }
  el.innerHTML = html;
  if (near) el.scrollTop = el.scrollHeight;
}

function peerHtml(u, isMe) {
  return '<div class="peer-item"><div class="peer-av" style="background:linear-gradient(135deg,' + u.color + '30,' + u.color + '10);border:2px solid ' + u.color + '55;color:' + u.color + '"><div class="st-dot" style="background:var(--grn)"></div>' + esc(u.avatar) + '</div><div><div style="font-weight:600;font-size:13px;color:' + u.color + '">' + esc(u.name) + (isMe ? ' <span style="color:var(--fnt);font-weight:400">(you)</span>' : '') + '</div></div></div>';
}

function updatePeers() {
  const peers = getPeers();
  const all = [S.me, ...peers];
  const n = all.length;
  const c = document.getElementById("sb-count"); if (c) c.textContent = "PEERS ‚Äî " + n;
  const sl = document.getElementById("sb-peers"); if (sl) sl.innerHTML = all.map((u, i) => peerHtml(u, i === 0)).join("");
  const hi = document.getElementById("hdr-info"); if (hi) hi.textContent = n + " peer" + (n !== 1 ? "s" : "") + " ‚Ä¢ end-to-end encrypted";
  const mh = document.getElementById("mem-hdr"); if (mh) mh.textContent = "ONLINE ‚Äî " + n;
  const ml = document.getElementById("mem-list"); if (ml) ml.innerHTML = all.map((u, i) => '<div class="peer-item"><div class="peer-av" style="background:linear-gradient(135deg,' + u.color + '30,' + u.color + '10);border:2px solid ' + u.color + '55;color:' + u.color + ';width:30px;height:30px;min-width:30px;font-size:12px"><div class="st-dot" style="background:var(--grn)"></div>' + esc(u.avatar) + '</div><span style="font-weight:500;font-size:13px;color:' + u.color + '">' + esc(u.name) + (i === 0 ? ' <span style="color:var(--fnt);font-weight:400">(you)</span>' : '') + '</span></div>').join("");
}

function updateTypBar() {
  const bar = document.getElementById("typ-bar"); if (!bar) return;
  const names = [];
  S.typing.forEach((_, pid) => { const u = S.knownUsers.get(pid); if (u) names.push(u.name); });
  bar.innerHTML = names.length ? '<span class="dot">‚óè</span><span class="dot" style="animation-delay:.15s">‚óè</span><span class="dot" style="animation-delay:.3s">‚óè</span> <strong>' + esc(names.join(", ")) + '</strong> ' + (names.length === 1 ? "is" : "are") + ' typing‚Ä¶' : '';
}

function updateToast() {
  const ex = document.querySelector(".copy-toast");
  if (S.copyToast && !ex) { const t = document.createElement("div"); t.className = "copy-toast"; t.textContent = "Room code copied!"; document.body.appendChild(t); }
  else if (!S.copyToast && ex) ex.remove();
}

// Global handlers for inline onclick
window.doReact = doReact;
window.doDelete = doDelete;
window.showEmoji = function(btn, mid) {
  document.querySelectorAll(".emoji-picker").forEach(p => p.remove());
  const pk = document.createElement("div"); pk.className = "emoji-picker";
  pk.innerHTML = EMOJIS.map(e => '<button class="emoji-opt" data-e="' + e + '">' + e + '</button>').join("");
  btn.closest(".msg-actions").appendChild(pk);
  pk.querySelectorAll(".emoji-opt").forEach(el => el.addEventListener("click", ev => { ev.stopPropagation(); doReact(mid, el.dataset.e); pk.remove(); }));
  setTimeout(() => { const cl = ev => { if (!pk.contains(ev.target)) { pk.remove(); document.removeEventListener("click", cl); } }; document.addEventListener("click", cl); }, 10);
};
window.startEdit = function(mid) {
  const msg = S.messages.find(m => m.id === mid); if (!msg) return;
  const el = document.getElementById("b-" + mid); if (!el) return;
  el.innerHTML = '<input class="edit-input" value="' + esc(msg.content).replace(/"/g, '&quot;') + '" id="ed-' + mid + '"><div style="font-size:11px;color:var(--fnt);margin-top:4px">escape to cancel ‚Ä¢ enter to save</div>';
  const inp = document.getElementById("ed-" + mid);
  if (inp) { inp.focus(); inp.setSelectionRange(inp.value.length, inp.value.length); inp.addEventListener("keydown", e => { if (e.key === "Enter") doEdit(mid, inp.value); if (e.key === "Escape") { lastHash = ""; updateMsgs(); } }); }
};

document.addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && e.key === "m") { e.preventDefault(); S.showMembers = !S.showMembers; const p = document.getElementById("mem-panel"); if (p) p.style.display = S.showMembers ? "" : "none"; }
  if (e.key === "Escape") document.querySelectorAll(".emoji-picker").forEach(p => p.remove());
});

doRender();
</script></body></html>
